---
title: "ODS y Municipios"
author: ""

output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    css: cre3.css
    vertical_layout: fill
    logo: logo_CR40.png
    theme: yeti
    navbar:
        - { title: "* Ver versión de 2024 del visor", href: "https://gaiacooperacion.net/proves/ods-valencia.html", align: "left", target: "_blank" }
---

<style>

div.chart-title { /* ================ Format inside: chart titles--- */
    font-weight: bold;
    color: #c52026;
}
.navbar-logo.pull-left {
  position: fixed;
  margin-top: 0px;
  background-color: white;
  margin-left: 0;
  width: 180px;
  height: 40px;
  top: 60px;
}
.header{
  position: fixed;
  height:45px;
  background: linear-gradient(#8e131d,#d21a2b);
  width: 90%;
  top:0;
  right:0;
  align-items: center;
  font-size: 14pt;
  font-weight: bold;
}

.left-side{
  position: inline-block;
  color: white;
  padding-left: 75px;
  float: left;
}

.right-side{
  display: inline-block;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  float: left;
  margin-left: 400px;
  right: 0;
}

</style>

<div class= "header" style="color: white;">
<p class="left-side">
Los ODS municipio por municipio en la Comunitat Valenciana - 2025
</p>

</div>


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(sf)
library(rmapshaper)
library(tmap)
library(leaflet)
library(readxl)
library(httr)
```

```{r include=FALSE}
#setwd("C:/DataPortatil/Estudis/CreuRojaVal/ODS/instrumentosYbbdd/")
```

```{r include=FALSE}
# MAPAS

# Mapa provincias
prov_sf <- st_read("Mapas/provincias-espanolas/provincias-espanolas.shp")

#prov_sf |> st_simplify(dTolerance = 1000, preserveTopology=FALSE)

# Mapa municipios
mun_sf <- st_read("Mapas/ca_municipios_20231105/ca_municipios_20231105.shp") |> 
  st_make_valid() |> 
  rmapshaper::ms_simplify(keep = 0.07, keep_shapes = TRUE) # Importante para poder simplificar el mapa sin dejar espacios vacíos. Hay que simplificar para bajar el peso del documento


```


```{r}

# Dataframe general de población total por municipios, para join con df que tienen código ine
# Años 2019, 2020, 2021, 2022, 2023

municipios <- readxl::read_xlsx("BasesdeDatos/Demografia/padronMunicipios.xlsx")

# Se separan diferentes df para diferentes años

municipios_19 <- municipios |> select(1,2,3)
municipios_20 <- municipios |> select(1,2,4)
municipios_21 <- municipios |> select(1,2,5)
municipios_22 <- municipios |> select(1,2,6)
municipios_23 <- municipios |> select(1,2,7)
municipios_24 <- municipios |> select(1,2,8)

```


```{r}

# Población por municipios y por categorias de edad (quinquenales)

poblEdad <- read_xlsx("BasesdeDatos/Demografia/padronEdades21-22.xlsx")


poblEdad22 <- poblEdad |> 
    select(1,2,3,5) # Poblacion por municipio y categoria de edad: año 2022

poblEdad21 <- poblEdad |> 
    select(1,2,3,4) # Poblacion por municipio y categoria de edad: año 2021

```


```{r}
# Población por edad año a año 2022
# https://www.ine.es/dynt3/inebase/index.htm?padre=6225&capsel=6225

mun_anyoanyo_2022 <- read_xlsx("BasesdeDatos/Demografia/Padron_Anyo-Anyo/Municipios22_AnyoAnyo.xlsx")

# Población por edad año a año 2023 2024
# # https://www.ine.es/dynt3/inebase/index.htm?padre=10607&capsel=10607

mun_anyoanyo_2023 <- read_xlsx("BasesdeDatos/Demografia/Padron_Anyo-Anyo/Municipios23_AnyoAnyo.xlsx")

mun_anyoanyo_2024 <- read_xlsx("BasesdeDatos/Demografia/Padron_Anyo-Anyo/Municipios24_AnyoAnyo.xlsx")

```



```{r}

# dataframe depurado de municipios para join con dataframe sin código ine, sino por nombre del municipios
munClean <- municipios[, c(1,2)] |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(mun1= str_sub(str_extract(Municipio, "(.*?)\\/"), end= -2),
           mun2= str_sub(str_extract(Municipio, "/.*"), start= 2),
           mun3= ifelse(!is.na(mun1), paste0(mun2,"/",mun1),NA)) |> 
    pivot_longer(c(2,3,4,5)) |> 
    distinct(value, .keep_all = TRUE) |> 
    filter(!is.na(value)) |> 
    rename(Municipio= value) |> 
    select(1,3)

# writexl::write_xlsx(munClean,"BasesdeDatos/ODS7/munClean.xlsx")

```


# ODS1 - Fin de la pobreza

## Column {.tabset}

### Tasa de población en riesgo de pobreza <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre datos del INE (2022)</i></c>

```{r}

# Lectura de las bases de datos del INE descargadas en el enlace:

# https://www.ine.es/jaxiT3/Tabla.htm?t=30838&L=
pobrAl <- read_xlsx("BasesdeDatos/ODS1/Pobreza2022/30838_PobrezaAlacant.xlsx",
                   skip = 9,
                   col_names = FALSE)


# https://www.ine.es/jaxiT3/Tabla.htm?t=30967&L=0
pobrCa <- read_xlsx("BasesdeDatos/ODS1/Pobreza2022/30967_PobrezaCastellon.xlsx",
                   skip = 9,
                   col_names = FALSE)

# https://www.ine.es/jaxiT3/Tabla.htm?t=31255&L=0
pobrVa <- read_xlsx("BasesdeDatos/ODS1/Pobreza2022/31255_PobrezaValencia.xlsx",
                   skip = 9,
                   col_names = FALSE)

pobr <- rbind(pobrAl,pobrCa,pobrVa)
pobr <- pobr |> 
    rename(Municipio= ...1,
         ods01.PobrSev= ...2,
         ods01.Pobr= ...3) |> 
    mutate(ine= str_sub(Municipio,1,5),
         Municipio=str_sub(Municipio,7,100),
         ods01.PobrSev= round(as.numeric(ods01.PobrSev),1),
         ods01.Pobr= round(as.numeric(ods01.Pobr),1))|> 
    select(4,1,2,3) |> 
    filter(grepl("^03|^12|^46", ine))

# writexl::write_xlsx(pobr, "BasesdeDatos/ODS7/pobreza.xlsx") # Se graba para analizar correlación con otras variables
  
pobr_sf <- mun_sf %>% merge(pobr, by.x = "MUNIINE", by.y="ine")

tmap_mode("view")

tm_shape(pobr_sf)+
    tm_fill(col="ods01.Pobr",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0,10,20,30,40,50),
            palette = c("papayawhip","darkred"),
            title = "Tasa de riesgo <br> de pobreza (%)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de Pobreza (%): "= "ods01.Pobr")) +
    tm_borders(col="grey40",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE) +
    tmap_options(basemaps = "Esri.WorldImagery",
               basemaps.alpha = 1)

```

### Tasa de pobresa severa <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre datos del INE (2022)</i></c>

```{r}

tm_shape(pobr_sf)+
    tm_fill(col="ods01.PobrSev",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0,5,10,15,20,30),
            palette = c("papayawhip","darkred"),
            title = "Tasa de pobreza <br> severa (%)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de Pobresa (%): "= "ods01.PobrSev")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

## Column {.tabset}

### Tasa de pobreza infantil severa <br> (menores de 18 años) <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre datos del INE (2022)</i></c>

```{r}

# Lectura de las bases de datos descargadas del enlace:

# https://www.ine.es/jaxiT3/Tabla.htm?t=30839&L=0
pInfAl <- read_xlsx("BasesdeDatos/ODS1/Pobreza2022/30839_PobInfAlacant.xlsx",
                   skip = 10,
                   col_names = FALSE)

# https://www.ine.es/jaxiT3/Tabla.htm?t=30968&L=0
pInfCa <- read_xlsx("BasesdeDatos/ODS1/Pobreza2022/30968_PobInfCastellon.xlsx",
                   skip = 10,
                   col_names = FALSE)
# https://www.ine.es/jaxiT3/Tabla.htm?t=31255&L=0
pInfVa <- read_xlsx("BasesdeDatos/ODS1/Pobreza2022/31256_PobInfValencia.xlsx",
                   skip = 10,
                   col_names = FALSE)

pInf <- rbind(pInfAl,pInfCa,pInfVa)
pInf <- pInf |> 
  rename(Municipio= ...1,
         ods01.PobrInfantil= ...2) |> 
  mutate(ine= str_sub(Municipio,1,5),
         Municipio=str_sub(Municipio,7,100),
         ods01.PobrInfantil= round(as.numeric(ods01.PobrInfantil),1))|> 
  select(3,1,2)
  
  
pInf_sf <- mun_sf %>% merge(pInf, by.x = "MUNIINE", by.y="ine")

tm_shape(pInf_sf)+
    tm_fill(col="ods01.PobrInfantil",
            id="Municipio",
            style = "fixed",
            n=7,
            breaks = c(0,5,10,15,20,25,30,40),
            palette = c("papayawhip","darkred"),
            title = "Tasa de pobreza <br> Infantil (%)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de Pobreza Infantil (%): "= "ods01.PobrInfantil")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

### Tasa por hab. de gasto municipal en promoción social <br> <d style= "font-size: 10px;">Gasto medio (2021-2023) en promoción social por hab. Cuenta 23 de Programas</d> <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre datos del Ministerio de Hacienda y Función Pública <br> (2021, 2022, 2023)</i></c>

```{r}

# Contabilidad de la partida 23 del gasto municipal del año 2021-2023
desp23_23 <- read_xlsx("BasesdeDatos/ODS1/Gasto21-23/desp23-2023.xlsx")
desp23_22 <- read_xlsx("BasesdeDatos/ODS1/Gasto21-23/desp23-2022.xlsx")
desp23_21 <- read_xlsx("BasesdeDatos/ODS1/Gasto21-23/desp23-2021.xlsx")

desp23 <- rbind(desp23_21,desp23_22,desp23_23)


desp23Val <- desp23 |> 
  filter(TipoAdm== "AA") |> 
  group_by(ine,anyo) |> 
  summarise(Gasto_23 = sum(Importe)) |> # Se calcula el importe por municipio y anyo
  ungroup() |> 
  inner_join(municipios_22, by= "ine") |> # se fusiona con df de municipios valencianos año 2022
  group_by(ine) |> # Se agrupa por municipios
  mutate(PrSocMed= mean(Gasto_23)) |>  # y se calcula el gasto medio
  ungroup() |> 
  select(1,4,5,6) |> 
  rename(Total= `2022`) |> # Población total
  distinct(ine, .keep_all = TRUE) |> 
  mutate(ods01.Gasto_23perHab= round(PrSocMed/Total,2), # Gasto medio /hab. sobre población de 2022
         ods01.Gasto_en_miles= round(PrSocMed/1000,2))


d23Val_sf <- mun_sf %>% left_join(desp23Val, by= c("MUNIINE"="ine"))

tm_shape(d23Val_sf)+
    tm_fill(col= "ods01.Gasto_23perHab",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0,50,100,200,400,5000),
            palette = c("white","darkgreen"),
            title = "Gasto medio (2021-2023) <br> partida social por habitante",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c(
                "Gasto social (en miles de €): "= "ods01.Gasto_en_miles",
                "Población (habitantes): "= "Total",
                "Gasto social/Habitante: "= "ods01.Gasto_23perHab"),
            popup.format = list(
                ods01.Gasto_en_miles= list(big.mark = ".",
                                           decimal.mark= ","),
                Total= list(big.mark = "."),
                ods01.Gasto_23perHab=list(decimal.mark=","))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

 

```

# ODS2 - Hambre cero

## Column {.tabset}

### Nivel estimado de Privación Material Severa <br> <d style= "font-size: 10px;">Estimación aprox. de la Tasa de Privación Material Severa (AROPE)</d> <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre datos del INE y datos territoriales del IVE (2022)</i></c>

```{r}

# Cálculo Tasa Privació Material Severa

comVal <- read_xlsx("BasesdeDatos/Demografia/comarcasVal.xlsx")
carCom <- read_xlsx("BasesdeDatos/ODS2/CerenciaSevera.xlsx")

priv <- pobr |> 
  inner_join(comVal, by='ine') |> # Esta fusión permite relacionar los municipios con sus comarcas
  inner_join(carCom, by= 'codCom') |> # Esta fusión permite relacionar los datos municipales con los valores medios comarcales de pobreza severa y privación material severa
  select(1,2,3,6,7,9,11) |> 
  rename(Municipio= Municipio.x,
         Comarca= Comarca.x,
         mediaTasaPobr=media, # Tasa comarc. media Pobreza Severa (INE)
         mediaTasaPriv= TasaPriv) # Tasa comar, de Privación Sev. (AROPE)

# Calculo tasa estimada de Privación Severa a partir de la diferencia entre la tasa
# de Pobreza Severa Municipal y la media Comarcal de la misma Tasa. Estimamos que la tasa municipal de privación material severa seguirá la misma tendencia

ods2.PrivEstimada <- priv |> 
  mutate(dif= ods01.PobrSev-mediaTasaPobr,
              percDif= dif/mediaTasaPobr) |> 
  mutate(ods2.PrivEstimada= mediaTasaPriv * (1 + percDif))

# Niveles privación
#1.49-4.41
#4.46-7.41
#7.43-10.3 
#10.5-13.4 



ods2.nivPriv <- 
  ods2.PrivEstimada |> 
  mutate(ods2.nivPriv= cut(ods2.PrivEstimada, 
                           breaks = c(0, 4.41, 7.41, 10.5, 100), 
                           labels = c(
                               "Tasa baja: menos de 4.41",
                               "Tasa medio-baja: 4.41-7.41%",
                               "Tasa medio-alta: 7.41-10.5",
                               "Tasa alta: más de 10.5%")),
         ods2.nivPriv= factor(ods2.nivPriv, levels= c(
             "Tasa baja: menos de 4.41",
             "Tasa medio-baja: 4.41-7.41%",
             "Tasa medio-alta: 7.41-10.5",
             "Tasa alta: más de 10.5%")))

ods2.nivPriv_sf <- mun_sf |> inner_join(ods2.nivPriv, by= c("MUNIINE"="ine"))

tm_shape(ods2.nivPriv_sf)+
    tm_fill(col= "ods2.nivPriv",
            id="Municipio",
            #style = "fixed",
            #n=5,
            #breaks = c(0,50,100,200,400,5000),
            palette = c("papayawhip","darkred"),
            title = "Privación material severa <br> Nivel estimado",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Estimación: "= "ods2.nivPriv")
            #             "Pobalción (habitantes): "= "Total",
            #             "Gasto social/Habitante: "= "ods1.Gasto_23perHab"),
            #popup.format = list(ods1.Gasto_en_miles= list(big.mark = ".",
            #                                   decimal.mark= ","),
            #                    Total= list(big.mark = "."),
              #                  ods1.Gasto_23perHab=list(decimal.mark=",")
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```


# ODS3 - Salud y bienestar

## Column {.tabset}

### Tasa de mortalidad prematura <br> <d style= "font-size: 10px;">Muertes 0-64 años / 1000 hab 0-64 años</d> <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre Datos y Microdatos <br> del INE (2023)</i></c>

```{r}

# Ratio de muertes prematuras de menores de 65 años por habitante en este rango de edad.

# DF generando por fichero de microdatos del INE procesado previamente
mort <- read_xlsx("BasesdeDatos/ODS3/pb054_2023_completo.xlsx")



# Simplificación de la tabla en 2 categorías de edad

poblCat23 <- mun_anyoanyo_2023 %>% 
    rowwise() %>% 
    mutate(tot64= sum(c_across(4:68)),
           tot65= sum(c_across(69:104))) %>% 
    select(1,2,105,106,3) %>% 
    rename(De.0.a.64.años= tot64,
           Más.de.64.años= tot65)


mort <- mort |> 
  mutate(ine= paste0(cprore,cmunre), # IMPORTANTE SON LOS CODIGO DE LA RESIDENCIA. NO CONFONDER CON CPROI Y CMUNI
         anon= as.numeric(anon),
         edad= 2023-anon) |>
  filter(!is.na(cmuni)) |>  # Los municipios de < de 10.000 habitantes quedan en blanco y se filtran
  select(12,13, 1:11)
  
mort_ine <- mort |> 
  filter(edad < 65) |> 
  count(ine)

tasaMP  <- poblCat23[, 1:3] |> 
  left_join(mort_ine[,1:2], by = 'ine') |> 
  mutate(ods3.tasaMP= round((n/De.0.a.64.años)*1000,2))

tasaMP_sf <- mun_sf %>% 
  merge(tasaMP, by.x = "MUNIINE", by.y="ine")



tm_shape(tasaMP_sf)+
    tm_fill(col= "ods3.tasaMP",
            id="Municipio",
            #style = "fixed",
            #n=7,
            #breaks = c(0,0.01,0.1,1,5,10,131),
            palette = c("papayawhip","darkred"),
            title = "Tasa de muertes prematuras (‰) <br> Edad 0-64 años",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c(
                         "Casos / 1.000 hab.: "= "ods3.tasaMP"),
            popup.format = list(ods3.tasaMP= list(decimal.mark = ",",
                                                  digits= 1)
                                )
            ) +
    #tm_layout(title = "UG (unidades ganaderas) / ha de pasto, cultivo herbáceo o berbecho",
     #         title.position = c("left","top"))+
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

### Edad media de defunción <br> <d style= "font-size: 10px;">Edad media de las personas decedidas durante el año</d> <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre Datos y Microdatos <br> del INE (2023)</i></c>

```{r}

edadMmort <- mort  |> 
    group_by(ine) |> 
    summarise(ods3.edadM= round(mean(edad),2))
  
edadMort <- municipios[, c(1,2)] |> left_join(edadMmort, by = 'ine')


edadMort_sf <- mun_sf |> left_join(edadMort, by= c("MUNIINE"= "ine"))

tm_shape(edadMort_sf)+
    tm_fill(col= "ods3.edadM",
            id="Municipio",
            style = "fixed",
            n=,
            breaks = c(74,76,78,80,82,86),
            palette = c("papayawhip","darkgreen"),
            title = "Edad media de defunción",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Edad media de defunción: "= "ods3.edadM"),
            popup.format = list(ods3.edadM = list(decimal.mark = ",")
                                )
            ) +
    #tm_layout(title = "UG (unidades ganaderas) / ha de pasto, cultivo herbáceo o berbecho",
     #         title.position = c("left","top"))+
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```

## Column {.tabset}

### Mortalidad por suicidio <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre Datos y Microdatos <br> del INE (2023)</i></c>

```{r }

suicid23 <- mort |> 
    select(ine, causar) |> 
    count(ine, causar) |> 
    pivot_wider(names_from = causar, values_from = n) |> 
    select(ine,`098`) |> 
    rename(suicidios= `098`) |>
    mutate(suicidios= ifelse(is.na(suicidios), 0, suicidios))

ods3.suic23 <- poblCat23[, c(1,2,5)] |> 
  left_join(suicid23, by = 'ine') |> 
  mutate(ods3.tasaSuic= round((suicidios/Total)*1000,2))

ods3.suic23_sf <- mun_sf |> inner_join(ods3.suic23, by= c("MUNIINE"= "ine"))

tm_shape(ods3.suic23_sf)+
    tm_fill(col= "ods3.tasaSuic",
            id="Municipio",
            #style = "fixed",
            #n=7,
            #breaks = c(0,0.01,0.1,1,5,10,131),
            palette = c("papayawhip","darkred"),
            title = "Tasa de muertes por suicidio (‰)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de muertes por suicidio (‰): "= "ods3.tasaSuic"),
            popup.format = list(ods3.tasaSuic= list(decimal.mark = ",",
                                                    digits=2))
            ) +
    #tm_layout(title = "UG (unidades ganaderas) / ha de pasto, cultivo herbáceo o berbecho",
     #         title.position = c("left","top"))+
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

### Mortalidad por infarto agudo de miocardio <br> <c style= "font-size: 10px;"> <i>Elaboracion propia sobre Datos y Microdatos <br> del INE (2023)</i></c>

```{r}

infarto <- mort |> 
    select(ine, causar) |> 
    count(ine,causar) |> 
    pivot_wider(names_from = causar, values_from = n) |> 
    select(ine,`055`) |> 
    rename(infartos= `055`) |>
    mutate(infartos= ifelse(is.na(infartos), 0, infartos))

ods3.infarto <- poblCat23[, c(1,2,5)] |> 
  left_join(infarto, by = 'ine') |> 
  mutate(ods3.tasaInf= round((infartos/Total)*1000,2))

ods3.infarto_sf <- mun_sf |> inner_join(ods3.infarto, by= c("MUNIINE"= "ine"))

tm_shape(ods3.infarto_sf)+
    tm_fill(col= "ods3.tasaInf",
            id="Municipio",
            #style = "fixed",
            #n=7,
            #breaks = c(0,0.01,0.1,1,5,10,131),
            palette = c("papayawhip","darkred"),
            title = "Tasa de muertes por infarto (‰)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de muertes por infarto (‰): "= "ods3.tasaInf"),
            popup.format = list(ods3.tasaInf= list(decimal.mark = ",",
                                                    digits=2))
            ) +
    #tm_layout(title = "UG (unidades ganaderas) / ha de pasto, cultivo herbáceo o berbecho",
     #         title.position = c("left","top"))+
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```


# ODS4 - Educación de calidad

## Column {.tabset}

### Completamiento segunda etapa <br> de Educación Secundaria <br> <d style= "font-size: 10px;">Completamiento segunda etapa de Educación Secundaria <br> y Educación Postsecundaria no Superior / Población total</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (Censo 2021-2022)</i></c>

```{r}

# Lectura del fichero excel sobre datos del Censo anual de población (Educación) 2021-2022, generado en:
# https://www.ine.es/dynt3/inebase/es/index.htm?padre=10608&capsel=10612
# Para municipios de 50-500 hab.: https://www.ine.es/jaxiT3/Tabla.htm?t=66623&L=0
# Para municipios de más de 500 hab.: https://www.ine.es/jaxiT3/Tabla.htm?t=66622&L=0

edu2 <- read_xlsx("BasesdeDatos/ODS4/educacion_secundaria.xlsx")


# Fusion con la tabla municipios_22, año 2022
eduNivel <- municipios_22 |> 
  left_join(edu2[c(1,3)], by= 'ine') |> 
  rename(Total= `2022`) |> 
  mutate(ods4.tasaSec= round(Valor/Total*100,1))


```

```{r}

tasaEdu_sf <- mun_sf %>% 
  merge(eduNivel, by.x = "MUNIINE", by.y="ine")



tm_shape(tasaEdu_sf) +
    tm_fill(col= "ods4.tasaSec",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0,10,20,30,40,50),
            palette = c("papayawhip","darkgreen"),
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            title = "Tasa completamiento 2ª etapa <br> de secundaria (%)",
            popup.vars=c("Población con segundo ciclo educación secundaria: "= "Valor",
                         "Población total: "= "Total",
                         "Tasa de secundo ciclo (%): "= "ods4.tasaSec"),
            popup.format = list(ods4.tasaSec= list(decimal.mark = ","),
                                Valor= list(big.mark= "."),
                                Total= list(big.mark= ".")
                                )
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```


### Tasa por hab. de gasto municipal en educación <br> <d style= "font-size: 10px;">Gasto medio (2021-2023) Municipal para la Política de gasto 32 de <br> Educación (€ per cápita)</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del Ministerio de Hacienda <br> y Función Pública (2021, 2022 y 2023)</i></c>

```{r}

desp32_23 <- read_xlsx("BasesdeDatos/ODS4/desp32-2023.xlsx")
desp32_22 <- read_xlsx("BasesdeDatos/ODS4/desp32-2022.xlsx")
desp32_21 <- read_xlsx("BasesdeDatos/ODS4/desp32-2021.xlsx")

desp32 <- rbind(desp32_23,desp32_22,desp32_21) # Se genera un df con datos económicos de 2022 y 2021

desp32 %>% filter(ine== "17092")

desp32Val <- desp32 |> filter(TipoAdm== "AA") |> 
  group_by(ine,anyo) |> 
  summarise(Gasto_32= sum(Importe)) |> # Se calcula el importe por municipio y anyo
  ungroup() |> 
  inner_join(municipios_22, by= "ine") |> # se fusiona con df de municipios valencianos año 2022
  group_by(ine) |> # Se agrupa por municipios
  mutate(PrEdMed= mean(Gasto_32)) |>  # y se calcula el gasto medio
  ungroup() |> 
  select(1,4,5,6) |> 
  rename(Total= `2022`) |> # Población total
  distinct(ine, .keep_all = TRUE) |> 
  mutate(ods4.Gasto_32perHab= round(PrEdMed/Total,2), # Gasto medio /hab. sobre población de 2022
         Gasto_en_miles= round(PrEdMed/1000,2))
 

desp32Val <- municipios[, c(1,2)] |> left_join(desp32Val[,-2], by= 'ine')


d32Val_sf <- mun_sf %>% left_join(desp32Val, by = c("MUNIINE"="ine"))

tm_shape(d32Val_sf)+
    tm_fill(col= "ods4.Gasto_32perHab",
            id="Municipio",
            style = "quantile",
            #n=5,
            #breaks = c(0,50,100,200,400,5000),
            palette = c("white","darkgreen"),
            title = "Gasto partida educativa <br> por habitante (€)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Gasto social (en miles de €): "= "Gasto_en_miles",
                         "Pobalción (habitantes): "= "Total",
                         "Gasto educativo/Habitante (€): "= "ods4.Gasto_32perHab"),
            popup.format = list(Gasto_en_miles= list(big.mark = "."),
                                Total= list(big.mark = "."),
                                ods4.Gasto_32perHab=list(decimal.mark=","))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

## Column

### Actividades de educación para el desarrollo en centros educativos del municipio (2020) <br> <d style= "font-size: 10px;">Realización de actividades de EpD cofinanciadas por la GVA, en centros educativos del municipio</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos de la Dirección General de Cooperación y Solidaridad (Convocatoria 2020)</i></c>

```{r}

# Lectura del df generado por la lecturas de las fichas pdf

a <- readxl::read_xlsx("BasesdeDatos/ODS4/EPD_process/FICHAS CENTROS (MODALIDAD A)/tabla1EPD.xlsx")

actEpd <- a |> 
    rename(Municipio= municipio) |> # ESTNDARDIZACIÓN DE CARACTERES
    mutate(Municipio= tolower(Municipio),
                       Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
                       Municipio= gsub("'", "", Municipio),
                       Municipio= gsub(",", "", Municipio),
                       Municipio= gsub("\\(", "", Municipio),
                       Municipio= gsub(")", "", Municipio)) |> 
    mutate(Municipio= case_when(Municipio== "el saler"~ "valencia", # Correccion de nombres incorrectos
                                .default = as.character(Municipio),
                                Municipio== "guardamar"~ "guardamar del segura",
                                Municipio== "lalcudia"~ "alcudia l",
                                Municipio== "la vall duixo"~ "vall duixo la",
                                Municipio== "benimamet"~ "valencia",
                                Municipio== "alcora"~ "alcora l",
                                Municipio== "tavernes de la valldgina"~ "tavernes de la valldigna",
                                Municipio== "portell"~ "portell de morella",
                                Municipio== "la mata"~ "mata de morella la",
                                Municipio== "salzadella"~ "salzadella la",
                                Municipio== "les coves de vinroma"~ "coves de vinroma les",
                                Municipio== "vilafranca del cid"~ "villafranca del cid",
                                Municipio== "catellfort"~ "castellfort",
                                Municipio== "atzeneta"~ "atzeneta del maestrat",
                                Municipio== "les useres"~ "useres les",
                                Municipio== "vistabella"~ "vistabella del maestrat",
                                Municipio== "valldigna"~ "tavernes de la valldigna",
                                Municipio== "leliana"~"eliana l",
                                Municipio== "villamarxant"~ "vilamarxant",
                                Municipio== "la font de la figuera"~ "font de la figuera la"))



resumEPD <- actEpd |> left_join(munClean, by= 'Municipio') |> # Fusión por nombre
    group_by(ine) |> 
    mutate(n=n()) |> 
    distinct(ine,.keep_all = TRUE) |> 
    select(10,11) |> arrange(ine)

ods4.epd <- municipios[, 1:2] |> 
    left_join(resumEPD, by= 'ine') |> 
    rename(ods4.epd.n = n) |> 
    mutate(ods4.epdSi= ifelse(is.na(ods4.epd.n), "No", "Sí"))

ods4.epd_sf <- mun_sf |> left_join(ods4.epd, by= c("MUNIINE"="ine"))

   
tm_shape(ods4.epd_sf)+
    tm_fill(col= "ods4.epdSi",
            id="Municipio",
            #style = "quantile",
            #n=5,
            #breaks = c(0,1,4,41),
            palette = c("white","#3BB143"),
            title = "Cobertura actividades de EpD <br> en el territorio (2020)",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Número de actividades de EPD: "= "ods4.epd.n"),
            popup.format = list(ods4.epd.n=list(digits=0))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

# ODS5 - Igualdad de género

## Column

### Tasa de delitos contra la libertad sexual <br> <d style= "font-size: 10px;">Delitos conta la libertad sexual registrados cada 10.000 habitantes</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del Ministerio de Interior (4º Informe trimestral de 2024)</i></c>

```{r}
# Lectura df datos criminalidad 4º trimestre 2024 y 2023

dfviol <- read_xlsx("BasesdeDatos/ODS5/09012 (1).xlsx",
                    skip= 6) |> 
    rename(ods5.violSex23= `5. Delitos contra la libertad sexual...2`,
           ods5.violSex24= `5. Delitos contra la libertad sexual...3`,
           Municipio= ...1) %>% 
    filter(grepl("03|12|46", Municipio),
           !grepl("NIPO", Municipio)) %>% 
    mutate(ine = str_sub(Municipio, 1,5),
           Municipio= str_sub(Municipio, 7,100)) %>% 
    select(4,1,2,3)


# SOLO SI HAY QUE RECUPERAR DATOS DE 2022 O ANTERIORES
#dfviol <- dfviol |> 
    #filter(!grepl("COMUNITAT", Municipio)) |>
    #filter(!grepl("Provincia", Municipio)) |> 
#    mutate(Municipio= str_remove(Municipio,"-Municipio de "),
#           Municipio= tolower(Municipio),
#           Municipio= stringi::stri_trans_general(Municipio, #"Latin-ASCII"),
#           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
#           Municipio= gsub("'", "", Municipio),
#           Municipio= gsub("`", "", Municipio),
#           Municipio= gsub("´","", Municipio),
#           Municipio= gsub(",", "", Municipio),
#           Municipio= gsub("\\(", "", Municipio),
#           Municipio= gsub(")", "", Municipio),
#           Municipio= sub("^la (.*)", "\\1 la", Municipio),
#           Municipio= sub("^el (.*)", "\\1 el", Municipio),
#           Municipio= sub("^les (.*)", "\\1 les", Municipio),
#           Municipio= sub("^los (.*)", "\\1 los", Municipio),
#           Municipio= trimws(Municipio, "both"),
#           Municipio= case_when(Municipio== "castellon de la plana/castello de la plana"~ 
#                                    "castello de la plana",
#                                .default = as.character(Municipio)))  # 

#Corrección denominaciones no coincidentes
#dfviol <- dfviol[ , c(1,2)] |> 
#    left_join(munClean, by = 'Municipio') |> 
#    filter(!is.na(ine))  # Limpieza

dfviol <- municipios_24 |> 
    left_join(dfviol[, c(1,3,4)], by= 'ine') |> 
    mutate(ods5.tasaViolSex24= round(ods5.violSex24/`2024`*10000,2)) %>% 
    inner_join(municipios_23[, c(1,3)]) %>% 
    mutate(ods5.tasaViolSex23= round(ods5.violSex23/`2023`*10000,2))


violSex_sf <- mun_sf |> inner_join(dfviol, by= c("MUNIINE"= "ine"))

tm_shape(violSex_sf)+
    tm_fill(col= "ods5.tasaViolSex24",
            id="Municipio",
            style = "quantile",
            #n=5,
            #breaks = c(0,1,4,41),
            palette = c("papayawhip","darkred"),
            title = "Tasa de delitos contra la libertad sexual <br> (Casos/10.000 habitantes)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Casos / 10.000 hab.: "= "ods5.tasaViolSex24",
                         "Población (habitantes): "= "2024",
                         "Casos registrados: "= "ods5.violSex24"),
            popup.format = list(
                ods5.tasaViolSex24= list(decimal.mark = ","),
                `2024`= list(big.mark = "."))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```

## Columns

### Participación del municipio a la Red Valenciana de Igualdad <br> <d style= "font-size: 10px;">Municipios miembros, directa o indirectamente (a través de una mancomunidad), de la Red</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos recopilados de la web de la Dirección General de Igualdad de la GVA y del  Ministerio de Política Territorial y Memoria Democrática (2025)</i></c>

```{r}

# Lectura del df generado por web scraping (ver ValIgual_scrape.Rmd)

red <- read_xlsx("BasesdeDatos/ODS5/RVI.xlsx")

munMancomunidades <- read_xlsx("BasesdeDatos/ODS5/Mancomunidades/mancomunidades25.xlsx")

# Fusión de los dos dataframe consiguiendo todos los municipios participantes
# Nombres municipios son repetidos
redBrut <- red[,1] |> 
    left_join(munMancomunidades, by= "Ayuntamiento.Mancomunidad") |> 
    mutate(Municipio = coalesce(Municipio,Ayuntamiento.Mancomunidad)) |> 
    distinct(Municipio, .keep_all = TRUE)

redBrutClean <- redBrut |> mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_match(Municipio,
                            "almassora/almazora"~ "almassora",
                            "castello de la plana/castellon de la plana"~
                            "castello de la plana",
                            "albalat del sorells"~ "albalat dels sorells",
                            "pobla de farnals"~ "pobla de farnals la",
                            "riba-roja del turia"~ "riba-roja de turia",
                            "villanueva de castellon"~ "castello",
                            "genovesel"~ "genoves el",
                            "enova"~ "enova l",
                            "llosa de ranes"~ "llosa de ranes la",
                            "pobla llarga"~ "pobla llarga la",
                            "polinya del xuquer"~ "polinya de xuquer",
                            "rafelguarafaf"~ "rafelguaraf",
                            "montesinos"~ "montesinos los",
                            "mata de morella"~ "mata de morella la",
                            "sanet i negrals"~ "sanet y negrals",
                            "nucia"~ "nucia la",
                            "vila joiosa"~ "villajoyosa/vila joiosa la",
                            "romana"~ "romana la",
                            "sant vicent del raspeig/san vicente del"~ 
                            "sant vicent del raspeig/san vicente del raspeig",
                            "alcora la"~ "alcora l",
                            "alfas del pi"~ "alfas del pi l",
                            "rafol dalmunia  el"~ "rafol dalmunia el",
                            "oropesa"~ "oropesa del mar",
                            "sant joan dalicante"~ "sant joan dalacant",
                            "vall de gallinera la" ~
                                "vall de gallinerala",
                                 .default = as.character(Municipio)
                                 ))

redIne <- redBrutClean[, 1:2] |> 
    left_join(munClean, by= "Municipio") |> 
    distinct(ine, .keep_all = TRUE) |> 
    select(3,2)

ods5.RVI <- municipios[, c(1,2)] |> # Fusión con municipios por INE
    left_join(redIne, by= "ine") |> 
    mutate(ods5.rvi= ifelse(is.na(Municipio.y), "No","Sí")) |> 
    rename(Municipio= Municipio.x)

ods5.RVI_sf <- mun_sf |> inner_join(ods5.RVI[, c(1,2,4)], by= c("MUNIINE"= "ine"))

tm_shape(ods5.RVI_sf)+
    tm_fill(col= "ods5.rvi",
            id="Municipio",
            #style = "quantile",
            n=5,
            #breaks = c(0,1,4,41),
            palette = c("white","#3BB143"),
            title = "Participación a la Red <br> Valenciana de Igualdad",
            legend.format = list(text.separator= '-'),
            textNA = 'Valor ausente',
            popup.vars=c("Municipio miembro de la Red Valenciana de Igualdad: "= "ods5.rvi")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```


# ODS6 - Agua limpia y saneamiento

## Column

### Vulnerabilidad municipal por contaminación de las aguas por nitratos <br> <d style= "font-size: 10px;">Vulnerabilidad por contaminación por nitratos en las aguas superficiales y/o subterráneas</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos de la GVA (2025)</i></c>

```{r}

# Limpieza y simplificacion nombres municipios para join

aguasSuterraneas <- read_xlsx("BasesdeDatos/ODS6/AguasSubterraneas.xlsx")

subt <- aguasSuterraneas |> rename(Municipio= AguasSubterr) |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_match(Municipio,
                                 "almassora/almazora"~ "almassora",
                                 "castello de la plana/castellon de la plana"~
                                     "castello de la plana",
                                 "albalat del sorells"~ "albalat dels sorells",
                                 "pobla de farnals"~ "pobla de farnals la",
                                 "riba-roja del turia"~ "riba-roja de turia",
                                 "villanueva de castellon"~ "castello",
                                 "genoves"~ "genoves el",
                                 "enova"~ "enova l",
                                 "llosa de ranes"~ "llosa de ranes la",
                                 "pobla llarga"~ "pobla llarga la",
                                 "polinya del xuquer"~ "polinya de xuquer",
                                 "rafelguarafaf"~ "rafelguaraf",
                                 "montesinos"~ "montesinos los",
                                 "mata de morella"~ "mata de morella la",
                                 "sanet i negrals"~ "sanet y negrals",
                                 "nucia"~ "nucia la",
                                 "vila joiosa"~ "villajoyosa/vila joiosa la",
                                 "romana"~ "romana la",
                                 "sant vicent del raspeig/san vicente del"~ 
                                     "sant vicent del raspeig/san vicente del raspeig",
                                 .default = as.character(Municipio)
                                 ))

aguasSubt <- subt |> inner_join(munClean) |> distinct(ine,.keep_all = TRUE)

vulnerSubt <- municipios[, c(1,2)] |> 
    left_join(aguasSubt, by= 'ine') |> 
    mutate(Municipio.y= ifelse(is.na(Municipio.y), 0, 1)) |> 
    rename(vulnerSubt= Municipio.y,
           Municipio= Municipio.x)


aguasSuperficiales <- read_xlsx("BasesdeDatos/ODS6/AguasSuperficiales.xlsx")

superf <- aguasSuperficiales |> rename(Municipio= AguasSuperf) |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_match(Municipio,
                                 "almassora/almazora"~ "almassora",
                                 "castello de la plana/castellon de la plana"~
                                     "castello de la plana",
                                 "albalat del sorells"~ "albalat dels sorells",
                                 "pobla de farnals"~ "pobla de farnals la",
                                 "riba-roja del turia"~ "riba-roja de turia",
                                 "villanueva de castellon"~ "castello",
                                 "genoves"~ "genoves el",
                                 "enova"~ "enova l",
                                 "llosa de ranes"~ "llosa de ranes la",
                                 "pobla llarga"~ "pobla llarga la",
                                 "polinya del xuquer"~ "polinya de xuquer",
                                 "rafelguarafaf"~ "rafelguaraf",
                                 "montesinos"~ "montesinos los",
                                 "mata de morella"~ "mata de morella la",
                                 "sanet i negrals"~ "sanet y negrals",
                                 "nucia"~ "nucia la",
                                 "vila joiosa"~ "villajoyosa/vila joiosa la",
                                 "romana"~ "romana la",
                                 "sant vicent del raspeig/san vicente del"~ 
                                     "sant vicent del raspeig/san vicente del raspeig",
                                 "montixelvo/montichelvo"~ "montitxelvo/montichelvo",
                                 "real de gandia"~ "real de gandia el",
                                 "villajoyosa/ vila joiosa la"~ "villajoyosa/vila joiosa la",
                                 "moncofar"~ "moncofa",
                                 "bena- vites"~ "benavites",
                                 "catarro- ja"~ "catarroja",
                                 "alcoral"~ "alcora l",
                                 "pobla de tornesa la"~ "pobla tornesa la",
                                 "xilxes /chilches"~ "xilxes/chilches",
                                 "figeroles"~ "figueroles",
                                 "alcocer de planes"~ "alcosser",
                                 "banimantell"~ "benimantell",
                                 "facheca"~ "fageca",
                                 .default = as.character(Municipio)
                                 ))
aguasSuper <- superf |> inner_join(munClean) |> distinct(ine, .keep_all = TRUE)

vulnerSup <- municipios[, c(1,2)] |> 
    left_join(aguasSuper, by= 'ine') |> 
    mutate(Municipio.y= ifelse(is.na(Municipio.y), 0, 1)) |> 
    rename(vulnerSup= Municipio.y,
           Municipio= Municipio.x)

ods6.vulnerNitr <- vulnerSubt |> 
    inner_join(vulnerSup[, c(1,3)], by='ine') |> 
    mutate(ods6.vulnerNitr= as.integer(vulnerSubt+vulnerSup),
           siSubt= ifelse(vulnerSubt==1, 'Sí', 'No'),
           siSup= ifelse(vulnerSup== 1, 'Sí','No')
           )

ods6.vulnerNitr_sf <- mun_sf |> inner_join(ods6.vulnerNitr, by= c("MUNIINE"="ine"))

tm_shape(ods6.vulnerNitr_sf)+
    tm_fill(col= "ods6.vulnerNitr",
            id="Municipio",
            style = "cat",
            n=3,
            breaks = c(0,1,2),
            palette = c("white","darkred"),
            title = "Vulnerabilidad a contaminación por nitratos:<br> Aguas superficiales y Aguas subterráneas",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Nivel de vulnerabilidad (0-1-2): "= "ods6.vulnerNitr",
                         "Nitratos en aguas supeficiales: "= "siSup",
                         "Nitratos en aguas subterráneas: "= "siSubt"),
            popup.format = list(ods6.vulnerNitr= list(digits=0))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)




```


# ODS7 - Energía asequible y no contaminante

## Column

### Tasa de viviendas con aislamiento deficiente <br> <d style= "font-size: 10px;">% De certificados energéticos con calificación "G"*(muy deficiente)(<br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del IVACE (2015-2024)</i></c>

```{r}

# Lectura del fichero de IVACE descargado y procesado previamente (ver Bases de datos/ODS7)
dfEfEn <- read_xlsx("BasesdeDatos/ODS7/eficienciaEnerg.xlsx") |> # Lectura y modificación de algunas columnas
    rename(Municipio= MUNICIPIO,
           etiqueta= CONSUMO_EP_LETRA,
           totEtiqueta= totLetra) |> 
    # filter(etiqueta== "G") |>  # Filtramos únicamente las líneas con la letra G que es la que nos interesa
    filter(totMunicipio!=1) %>% # Filtramos outlyers que deforman excesivamente la distribución. En este caso un municipio con una sola puntuación total que obentdía un 100%
    select(-5) %>%  # Eliminem la columna "tasa", que calcularem després
    pivot_wider(names_from = etiqueta, 
                values_from = totEtiqueta,
                values_fill = 0) %>% 
    select(1,2,9) %>% 
    mutate(ods7.tasaLetraG= round(G/totMunicipio*100,1))

# Limpieza de los nombres de municipio para facilitar el encaje con la bbdd de municipio

dfEfEnClean <- dfEfEn |> 
    mutate(Municipio= tolower(Municipio),
                       Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
                       Municipio= gsub("'", "", Municipio),
                       Municipio= gsub(",", "", Municipio),
                       Municipio= gsub("\\(", "", Municipio),
                       Municipio= gsub(")", "", Municipio)) |> 
    mutate(Municipio= case_when(Municipio== "alboraya"~ "alboraia/alboraya",
                                Municipio== "alcocer de planes"~ "alcosser",
                                Municipio== "alfarp"~ "alfarb",
                                Municipio== "algimia de alfara"~ "algimia dalfara",
                                Municipio== "almazora/almassora"~ "almassora",
                                Municipio== "alquerias del nino perdido"~ 
                                    "alqueries les/alquerias del nino perdido",
                                Municipio== "benasal"~ "benassal",
                                Municipio== "burriana"~ "borriana/burriana",
                                Municipio== "calpe/calp"~ "calp",
                                Municipio== "adsubia"~ "atzubia l",
                                Municipio== "chert/xert"~ "xert",
                                Municipio== "el castell de guadalest"~ "castell de guadalest el",
                                Municipio== "genoves"~ "genoves el",
                                Municipio== "guadasequies"~ "guadassequies",
                                Municipio== "hondon de las nieves"~ 
                                    "fondo de les neus el/hondon de las nieves",
                                Municipio== "jalon/xalo"~ "xalo",
                                Municipio== "lucena del cid"~ "llucena/lucena del cid",
                                Municipio== "lugar nuevo de la corona"~ "llocnou de la corona",
                                Municipio== "monserrat"~ "montserrat",
                                Municipio== "montroy"~ "montroi/montroy",
                                Municipio== "naquera"~ "naquera/naquera",
                                Municipio== "masalaves"~ "massalaves",
                                Municipio== "novele/novetle"~ "novetle",
                                
                                Municipio== "peniscola"~ "peniscola/peniscola",
                                Municipio== "puig"~ "puig de santa maria el",
                                Municipio== "rafelbunol/rafelbunyol"~ "rafelbunyol",
                                Municipio== "real de gandia"~ "real de gandia el",
                                Municipio== "real de montroi"~ "real",
                                Municipio== "villalonga"~ "vilallonga/villalonga",
                                Municipio== "villarreal/vila-real"~ "vila-real",
                                Municipio== "vistabella del maestrazgo"~ "vistabella del maestrat",
                                Municipio== "pinoso"~ "pinos el/pinoso",
                                .default = as.character(Municipio)))


ods7.EfEn <- dfEfEnClean |> 
    left_join(munClean, by= "Municipio") |> 
    select(5,1:4)

ods7.EfEn <- municipios[,1:2] |> left_join(ods7.EfEn[, c(1,3:5)], by= 'ine')

# writexl::write_xlsx(ods7.EfEn, "BasesdeDatos/ODS7/bajaEficEn.xlsx") # Se graba para analizar correlación con otras variables

ods7.EfEn_sf <- mun_sf |> left_join(ods7.EfEn, by = c("MUNIINE"= "ine"))

tm_shape(ods7.EfEn_sf)+
    tm_fill(col= "ods7.tasaLetraG",
            id="Municipio",
            style = "quantile",
            #n=5,
            #breaks = c(0,1,4,41),
            palette = c("papayawhip","darkred"),
            title = "Tasa de certificados con <br> baja clasificación (G) (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de certificados (%) con muy baja calificación (G): "= "ods7.tasaLetraG",
                         "Totales certificados: "= "totMunicipio"),
            popup.format = list(ods7.tasaLetraG= list(decimal.mark = ","),
                                totMunicipio= list(big.mark = "."))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)




```

## Column

### Nivel estimado de riesgo de vulnerabilidad energética <br> <d style= "font-size: 10px;">Nivel estimado de pobreza energética en base a la pobreza severa y a la tasa de edificios de baja calidad energética</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (Censo 2021) y del IVACE</i></c>

```{r}

# CÁLCULO ÍNDICES


a <- ods7.EfEn |> 
    select(1,2,5) |> 
    mutate(minim= min(na.omit(ods7.tasaLetraG)),
           maxim= max(na.omit(ods7.tasaLetraG))) %>% 
    group_by(ine, Municipio) %>%
    mutate(ods7.indexG = (ods7.tasaLetraG - minim) / (maxim - minim)) %>% 
    mutate(ods7.nivelLetraG= cut(ods7.indexG,
                                 breaks = c(-.00001, .25, .5, .75, 1),
                                 labels =c("Nivel bajo",
                                             "Nivel medio-bajo",
                                             "Nivel medio-alto",
                                             "Nivel alto")))

b <- pobr |> 
    mutate(minim= min(na.omit(ods01.PobrSev)),
           maxim= max(na.omit(ods01.PobrSev))) %>% 
    group_by(ine, Municipio) %>%
    mutate(ods01.indexpobrSev = (ods01.PobrSev - minim) / (maxim - minim)) %>% 
    mutate(ods1.nivelPobrSev= cut(ods01.indexpobrSev,
                                 breaks = c(-.00001, .25, .5, .75, 1),
                                 labels =c("Nivel bajo",
                                             "Nivel medio-bajo",
                                             "Nivel medio-alto",
                                             "Nivel alto")))

nivPobrEn <- b[,c(1,7:8)] |>
    inner_join(a[, c(1,6:7)], by= 'ine') |> 
    mutate(ods7.nivRiesVulnEn= 
               case_when(
ods1.nivelPobrSev== "Nivel alto" & ods7.nivelLetraG== "Nivel alto"~ "Muy alto",
ods1.nivelPobrSev== "Nivel alto" & ods7.nivelLetraG== "Nivel medio-alto"~ "Muy alto",
ods1.nivelPobrSev== "Nivel alto" & ods7.nivelLetraG== "Nivel medio-bajo"~ "Alto",
ods1.nivelPobrSev== "Nivel alto" & ods7.nivelLetraG== "Nivel bajo"~ "Medio",
ods1.nivelPobrSev== "Nivel medio-alto" & ods7.nivelLetraG== "Nivel alto"~ "Muy alto",
ods1.nivelPobrSev== "Nivel medio-alto" & ods7.nivelLetraG== "Nivel medio-alto"~ "Alto",
ods1.nivelPobrSev== "Nivel medio-alto" & ods7.nivelLetraG== "Nivel medio-bajo"~ "Medio",
ods1.nivelPobrSev== "Nivel medio-alto" & ods7.nivelLetraG== "Nivel bajo"~ "Medio",
ods1.nivelPobrSev== "Nivel medio-bajo" & ods7.nivelLetraG== "Nivel alto"~ "Alto",
ods1.nivelPobrSev== "Nivel medio-bajo" & ods7.nivelLetraG== "Nivel medio-alto"~ "Medio",
ods1.nivelPobrSev== "Nivel medio-bajo" & ods7.nivelLetraG== "Nivel medio-bajo"~ "Medio",
ods1.nivelPobrSev== "Nivel medio-bajo" & ods7.nivelLetraG== "Nivel bajo"~ "Bajo",
ods1.nivelPobrSev== "Nivel bajo" & ods7.nivelLetraG== "Nivel alto"~ "Medio",
ods1.nivelPobrSev== "Nivel bajo" & ods7.nivelLetraG== "Nivel medio-alto"~ "Medio",
ods1.nivelPobrSev== "Nivel bajo" & ods7.nivelLetraG== "Nivel medio-bajo"~ "Bajo",
ods1.nivelPobrSev== "Nivel bajo" & ods7.nivelLetraG== "Nivel bajo"~ "Bajo")) |>
    mutate(ods7.nivRiesVulnEn= factor(ods7.nivRiesVulnEn, 
                                      levels= c("Bajo","Medio", "Alto", "Muy alto"))) |> 
    mutate(ods7.numNivRiesVulnEn= case_match(ods7.nivRiesVulnEn,
                                             "Bajo"~ 1,
                                             "Medio"~ 2,
                                             "Alto"~ 3,
                                             "Muy alto"~ 4)) |> 
    inner_join(municipios[, 1:2]) |> 
    select(1,8,2,4,6,7)
    

ods7.nivPobrEn_sf <- mun_sf |> inner_join(nivPobrEn, by = c("MUNIINE"= "ine"))

tm_shape(ods7.nivPobrEn_sf)+
    tm_fill(col= "ods7.nivRiesVulnEn",
            id="Municipio",
            #style = "quantile",
            #n=4,
            #breaks = c(0,1,2,3,4),
            palette = c("papayawhip","darkred"),
            title = "Nivel de riesgo de vulnerabilidad energética",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars= c("Nivel de vulnerabilidad energética: "= "ods7.nivRiesVulnEn",
                          "Índex de pobreza severa" = "ods01.indexpobrSev",
                          "Índex de ineficiencia energética"= "ods7.indexG")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```

# ODS8: Trabajo decente y crecimiento económico

## Column {.tabset}

### Tasa de demandantes de empleo sobre la población entre 16 y 64 años <br> <d style= "font-size: 10px;">Demandantes de empleo totales sobre población total</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (2024) y del Servei Valencià d'Ocupació i Formació (2024)</i></c>

```{r}

# Parados registrados a 31/12/2024
# Datos: https://labora.gva.es/va/estadisticassispehtml


datosParo <- read_xlsx("BasesdeDatos/ODS8/datosParo2024.xlsx")

# Recupera la población año a año
pob16_64 <- mun_anyoanyo_2024 |> 
    select(1:2,20:68) |> # Cod. INE, Municipio y Edad de 16 a 64
    rowwise() |> 
    mutate(suma16_64= sum(c_across(3:51))) |> 
    select(1,2,52)

tasaParo <- datosParo |> 
    inner_join(pob16_64[, c(1,3)], by= 'ine') |> 
    mutate(Demandantes= as.integer(Demandantes),
           ods8.tasaParo= round(Demandantes/suma16_64*100,1))


ods8.tasaParo_sf <- mun_sf |> left_join(tasaParo, by= c("MUNIINE"="ine"))

tm_shape(ods8.tasaParo_sf)+
    tm_fill(col= "ods8.tasaParo",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0, 6.32, 7.6, 8.7, 10.48, 25), # Se mantienen los cortes de 2024
            palette = c("papayawhip","darkred"),
            title = "Parados sobre población <br>en edad laboral (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de parados (%): "= "ods8.tasaParo",
                         "Total demandantes de empleo: "= "Demandantes",
                         "Población entre 16 y 64 años (2024)"= "suma16_64"),
            popup.format = list(ods8.tasaParo= list(decimal.mark = ","),
                                Demandantes= list(big.mark = "."),
                                suma16_64= list(big.mark = "."))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```

## Column

### Tasa de demandantes de empleo menores de 25 años<br> <d style= "font-size: 10px;">Demandantes de empleo totales Menores de 25 años sobre población total entre 16 y 25 años</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del IVE (2024) y del Servei Valencià d'Ocupació i Formació (2024)</i></c>

```{r}
# Datos del Estadística del Censo de Población 2021-2024							

# Recuperamos objeto, mun_anyoanyo_202 población año a año.

mun2024Jov <- mun_anyoanyo_2024 |> 
    select(1:2,20:28) |> 
    rowwise() |> 
    mutate(suma_16_24= sum(c_across(3:11))) |> 
    select(1,2,12)

# Parados registrados menores de 25 años a 31/12/2024

parJuv24 <- read_xlsx("BasesdeDatos/ODS8/datosParoJuvenil2024.xlsx")

# Parados sobre población 15-24

ods8.paroJuv <- mun2024Jov[, c(1,2,3)] |> 
    inner_join(parJuv24[, c(1,3)], by= 'ine') |> 
    mutate(ods8.tasaJuv= round(Parados / suma_16_24*100,1))

ods8.paroJuv_sf <- mun_sf |> inner_join(ods8.paroJuv, by= c("MUNIINE"="ine"))


tm_shape(ods8.paroJuv_sf)+
    tm_fill(col= "ods8.tasaJuv",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0, 1.9, 3.2, 4.26, 5.6, 50), # Se mantienen los cortes de 2024
            palette = c("papayawhip","darkred"),
            title = "Tasa de parados menores de 25 <br> sobre població de 16-24 años (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de demandantes menores de 25 años (%): "= "ods8.tasaJuv",
                         "Total demandantes de empleo menores de 25 años: "= "Parados",
                         "Población total de 16-24 años (2024)"= "suma_16_24"),
            popup.format = list(ods8.tasaJuv= list(decimal.mark = ","),
                                Parados= list(big.mark = "."),
                                suma_16_24= list(big.mark = "."))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)




```


# ODS10 - Reducción de las desigualdades

## Column {.tabset}

### Tasa de personas con ingresos inferiores <br> al 50% de la mediana <br> <d style= "font-size: 10px;"> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (2022)</i></c>

```{r}

# Lectura y procesamiento datos descargados del Atlas de distribución de renta de los hogares - INE: https://www.ine.es/dynt3/inebase/index.htm?padre=7132

tasaAl_50 <- read_xlsx("BasesdeDatos/ODS10/30838.xlsx",
         skip = 9,
         col_names = FALSE,
         col_types = c("text", "numeric")) |> 
    rename(Municipio= ...1,
           ods10.tasa50= ...2) |> 
    filter(grepl("^03|^12|^46", Municipio))
    
tasaCas_50 <- read_xlsx("BasesdeDatos/ODS10/30967.xlsx",
         skip = 9,
         col_names = FALSE,
         col_types = c("text", "numeric")) |> 
    rename(Municipio= ...1,
           ods10.tasa50= ...2) |> 
    filter(grepl("^03|^12|^46", Municipio))

tasaVal_50 <- read_xlsx("BasesdeDatos/ODS10/31255.xlsx",
         skip = 9,
         col_names = FALSE,
         col_types = c("text", "numeric")) |> 
    rename(Municipio= ...1,
           ods10.tasa50= ...2) |> 
    filter(grepl("^03|^12|^46", Municipio))

ods10.tasa_50 <- rbind(tasaAl_50,tasaCas_50,tasaVal_50) |> 
   mutate(ine= str_sub(Municipio, 1, 5),
           Municipio= str_sub(Municipio, 7,100)) |> 
    select(3,1,2)

ods10.tasa50_sf <- mun_sf |> inner_join(ods10.tasa_50, by = c("MUNIINE"= "ine"))

tm_shape(ods10.tasa50_sf)+
    tm_fill(col= "ods10.tasa50",
            id="Municipio",
            style = "quantile",
            n=5,
            breaks = c(3.7, 10, 12.38,14.10,18.70,34.8),  # Se mantienen los cortes de 2024
            palette = c("papayawhip","darkred"),
            title = "Tasa de personas con ingresos inferiores <br> al 50% de la mediana (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de personas con ingresos inferiores al 50% de la mediana (%): "= "ods10.tasa50"),
            popup.format = list(ods10.tasa50= list(decimal.mark = ","))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```


### Índice Gini <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (2022)</i></c>

```{r}

# Lectura y procesamiento datos descargados del Atlas de distribución de renta de los hogares - INE: https://www.ine.es/dynt3/inebase/index.htm?padre=7132

tasaAl_Gini <- read_xlsx("BasesdeDatos/ODS10/37733.xlsx",
         skip = 8,
         col_names = FALSE,
         col_types = c("text", "numeric")) |> 
    rename(Municipio= ...1,
           ods10.gini= ...2) |> 
    filter(grepl("^03|^12|^46", Municipio)) |> 
    select(1,2)

tasaCas_Gini <- read_xlsx("BasesdeDatos/ODS10/37691.xlsx",
         skip = 8,
         col_names = FALSE,
         col_types = c("text", "numeric")) |> 
    rename(Municipio= ...1,
           ods10.gini= ...2) |> 
    filter(grepl("^03|^12|^46", Municipio)) |> 
    select(1,2)

tasaVal_Gini <- read_xlsx("BasesdeDatos/ODS10/37721.xlsx",
         skip = 8,
         col_names = FALSE,
         col_types = c("text", "numeric")) |> 
    rename(Municipio= ...1,
           ods10.gini= ...2) |> 
    filter(grepl("^03|^12|^46", Municipio)) |> 
    select(1,2)

ods10.Gini <- rbind(tasaAl_Gini,tasaCas_Gini,tasaVal_Gini) |> 
    mutate(ine= str_sub(Municipio, 1, 5),
           Municipio= str_sub(Municipio, 7,100)) |> 
    select(3,1,2)

ods10.Gini_sf <-mun_sf |> inner_join(ods10.Gini, by= c("MUNIINE"="ine"))

tm_shape(ods10.Gini_sf)+
    tm_fill(col= "ods10.gini",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(20.6,26,27.3,28.7,30.7,38.4), # Se mantienen los cortes de 2024
            palette = c("papayawhip","darkred"),
            title = "Índice Gini 1-100",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Índice Gini (1-100): "= "ods10.gini"),
            popup.format = list(ods10.gini= list(decimal.mark = ","))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```

## Column

### Tasa de dependencia <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (2024)</i></c>

```{r}

# Datos del Estadística del censo anual 2021-2024.							
# Población de 2024 de población por edad
# Recuperamos objeto, mun_anyoanyo_2024 población año a año.


pobCat <- mun_anyoanyo_2024 |> 
    rowwise() |> 
    mutate(menos16= sum(c_across(4:19)),
           mas64= sum(c_across(69:104)), 
           de16a64= sum(c_across(20:68))
           )|> 
    select(1,2,3,105,107,106)




ods10.Dep <- pobCat |> 
    mutate(ods10.Dep= round((menos16+mas64)/de16a64*100,1)) |> arrange(ine)


ods10.Dep_sf <- mun_sf |> inner_join(ods10.Dep[, c(1,2,3,7)], by= c("MUNIINE"="ine"))

tm_shape(ods10.Dep_sf)+
    tm_fill(col= "ods10.Dep",
            id="Municipio",
            style = "fixed",
            n=5,
            breaks = c(0,50.7,54,58.6,68.2,128.6),
            palette = c("papayawhip","darkred"),
            title = "Tasa de dependencia (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de dependencia - 2022 (%): "= "ods10.Dep",
                         "Población total -2022: "= "Total"),
            popup.format = list(ods10.Dep= list(decimal.mark = ","),
                                Total= list(big.mark = "."))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```



# ODS11 - Ciudades y comunidades sostenibles

## Column {.tabset}

### Vulnerabilidad urbana <br> <d style= "font-size: 10px;">% De población que vive en secciones vulnerables</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del INE (2022)</i></c>

```{r}
# Según nuestra definición: Sección vulnerable cuando la Tasa de Riesgo de pobreza supera la media de la Provincia a que pertenece el municipio. Es una adaptación de la definición de Sisto, R., Quintanilla, A., García, J., 2020, que utilizan la media nacional como referencia.

# Lectura y limpieza datos de riesgo de pobreza por secciones censales:
# Datos descargados de: INE - Atlas de distribución de renta de los hogares - Resultados por municipios, distritos y secciones censales => https://www.ine.es/dynt3/inebase/index.htm?padre=7132
# Extraer el excel únicamente por secciones, no por municipios.

AlPobSec <- read_xlsx("BasesdeDatos/ODS11/Pobr22SeccAl30838.xlsx",
          skip = 9,
          col_names = FALSE,
          col_types = c("text", "numeric")) |> 
    filter(grepl("^03", ...1)) |> 
    rename(Municipio=...1,
           TasaPob=...2) |> 
    mutate(ine= str_sub(Municipio, 1,5),
           seccion= str_sub(Municipio,1,10),
           nombre= str_sub(Municipio, 12,100),
           nombre= str_remove(nombre, " sección.*")) |> 
    rename(denom= Municipio,
           Municipio= nombre) |> 
    select(5,3,4,2,1)

CasPobSec <- read_xlsx("BasesdeDatos/ODS11/Pobr22SeccCas30967.xlsx",
          skip = 9,
          col_names = FALSE,
          col_types = c("text", "numeric")) |>
    filter(grepl("^12", ...1)) |> 
    rename(Municipio=...1,
           TasaPob=...2) |> 
    mutate(ine= str_sub(Municipio, 1,5),
           seccion= str_sub(Municipio,1,10),
           nombre= str_sub(Municipio, 12,100),
           nombre= str_remove(nombre, " sección.*")) |> 
    rename(denom= Municipio,
           Municipio= nombre) |> 
    select(5,3,4,2,1)

ValPobSec <- read_xlsx("BasesdeDatos/ODS11/Pobr22SeccVal31255.xlsx",
          skip = 9,
          col_names = FALSE,
          col_types = c("text", "numeric")) |> 
    filter(grepl("^46", ...1)) |>
    rename(Municipio=...1,
           TasaPob=...2) |> 
    mutate(ine= str_sub(Municipio, 1,5),
           seccion= str_sub(Municipio,1,10),
           nombre= str_sub(Municipio, 12,100),
           nombre= str_remove(nombre, " sección.*")) |> 
    rename(denom= Municipio,
           Municipio= nombre) |> 
    select(5,3,4,2,1)

pobrSecc <- rbind(AlPobSec,CasPobSec,ValPobSec)

# Lectura y limpieza datos de habitantes por sección censal - Descargados de INE Estadística del Censo de Poblacion 2021-2024. Datos por secciones censales: 
#https://www.ine.es/dynt3/inebase/index.htm?padre=11555&capsel=11100

# Se descargan los datos de 2021 porque los datos de pobreza por seccion censal están disponibles para aquel año.


habSecAl <- read_xlsx("BasesdeDatos/ODS11/Hab22SeccAl0301.xlsx",
                      skip = 8,
                      col_names = FALSE) |> 
    rename(seccion= ...1,
           habitantes= ...2) |> 
    mutate(ine= str_sub(seccion, 1,5)) |> 
    filter(grepl("^03", seccion))

habSecCas <- read_xlsx("BasesdeDatos/ODS11/Hab22SeccCas1201.xlsx",
                      skip = 8,
                      col_names = FALSE) |> 
    rename(seccion= ...1,
           habitantes= ...2) |> 
    mutate(ine= str_sub(seccion, 1,5)) |> 
    filter(grepl("^12", seccion))

habSecVal <- read_xlsx("BasesdeDatos/ODS11/Hab22SeccVal4601.xlsx",
                      skip = 8,
                      col_names = FALSE) |> 
    rename(seccion= ...1,
           habitantes= ...2) |> 
    mutate(ine= str_sub(seccion, 1,5)) |> 
    filter(grepl("^46", seccion))

habSecc <- rbind(habSecAl,habSecCas,habSecVal) %>%  # Fusión de los tres datasets
    mutate(denom= seccion,
           seccion= str_sub(seccion,1,10),
           habitantes= as.integer(habitantes))

# Lectura datos pobreza provincial. Descargados de https://www.ine.es/jaxiT3/Tabla.htm?t=53694&L=0

pobrProv <- read_xlsx("BasesdeDatos/ODS11/PobrProv53694.xlsx", 
          range = "A10:B12",
          col_names = FALSE) |> 
    mutate(prov= c("03","12","46")) |> 
    rename(Provincia=...1,
           tasaPobProv=...2)

ods11.vulner <- habSecc |> 
    inner_join(pobrSecc[, c(1,3,4)], by = 'seccion') |> # Fusión tablas pobreza y población
    mutate(prov= str_sub(ine,1,2)) |> 
    inner_join(pobrProv, by= "prov") |> # Fusión tabla valores provinciales
    #group_by(prov) |> 
    #mutate(desvEstProv= sd(TasaPob,na.rm=TRUE)) |> 
    #ungroup() |> 
    mutate(LimVulnerable= tasaPobProv,
           SeccVulnerable= ifelse(TasaPob>=LimVulnerable, 1, 0),
           pobSeccVuln= ifelse(SeccVulnerable == 1, habitantes, 0)) |> 
    group_by(ine, Municipio) |> 
    summarise(pobTot= sum(habitantes),pobVuln= sum(pobSeccVuln), 
              ods11.tasaVuln= round(pobVuln/pobTot*100,1))

ods11.vulner_sf <- mun_sf |> inner_join(ods11.vulner, by= c("MUNIINE"="ine"))

tm_shape(ods11.vulner_sf)+
    tm_fill(col= "ods11.tasaVuln",
            id="Municipio",
            #style = "quantile",
            #n=5,
            #breaks = c(0,20,40,21.4),
            palette = c("white","darkred"),
            title = "Vulnerabilidad urbana (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de vulnerabilidad urbana - 2021 (%): "= "ods11.tasaVuln"),
            popup.format = list(ods11.tasaVuln= list(decimal.mark = ","))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```

## Column {.tabset}

### Nivel de contaminación por PM10 <br> <d style= "font-size: 10px;">Días con concentración de  PM10 > 40 μg/m3</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del Ministerio de <br> Transición Tecnológica y Reto Demográfico (2023)</i></c>

```{r}

# Lectura, limpieza y filtrado para CVA de los datos PM10
# Descargados de https://www.miteco.gob.es/es/calidad-y-evaluacion-ambiental/temas/atmosfera-y-calidad-del-aire/evaluacion-y-datos-de-calidad-del-aire/datos/datos-oficiales-2023.html

tabPM10cva <- read_xlsx("BasesdeDatos/ODS11/datosPM10cva2023.xlsx")

PM10Clean <- tabPM10cva |> 
    pivot_longer(9:39, values_to = "PM10") |> 
    mutate(fecha= format(as.Date(paste0(str_sub(name,2,3),"-",MES,"-",ANNO),
                                 "%d-%m-%Y"), "%d/%m/%Y"), # Fecha
           categoria= ifelse(PM10<21,1,   # Categorias de calidad del aire (PM10), según ANEXO de la Orden TEC/351/2019, de 18 de marzo
                             ifelse(PM10<41,2,
                                    ifelse(PM10<51,3,
                                           ifelse(PM10<101,4,
                                                  ifelse(PM10<151,5,
                                                         NA)))))) |> 
    select(1,4,5,6,11,10,12)

ods11.PM10sup <- PM10Clean |> 
    group_by(ine,ESTACION,categoria) |> 
    summarise(n=n()) |> # Se cuentan las medidas por estaciones y categorías
    ungroup() |> 
    filter(categoria>2) |> # Se filtran 
    group_by(ine, ESTACION) |> 
    summarise(sup= sum(n)) |> 
    ungroup() |> 
    group_by(ine) |> 
    summarise(ods11.maxPM10= max(sup))

ods11.pm10_sf <- mun_sf|>  
    inner_join(municipios, by= c("MUNIINE"= "ine")) |> 
    left_join(ods11.PM10sup, by= c("MUNIINE"= "ine"))

tm_shape(ods11.pm10_sf)+
    tm_fill(col= "ods11.maxPM10",
            id="Municipio",
            #style = "quantile",
            #n=5,
            #breaks = c(0,.5,2,21.4),
            palette = c("papayawhip","darkred"),
            title = "Número de días del año que se ha <br> superado 40 μg/m3 - 2023",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Número de días: "= "ods11.maxPM10"),
            popup.format = list(ods11.maxPM10= list(digits = 0))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```



### Índice de despoblación <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del IVE (2024)</i></c>

```{r}
# Banco de datos territorial: https://bdt.gva.es/bdt

# Origen datos "https://bdt.gva.es/bdt/res_optimo_static.php?cons=C0V6449&idioma=cas&form=xlsx"

# Lectura de los datos tratados anteriormente
dens24 <- read_xlsx("BasesdeDatos/Demografia/densidad2024.xlsx") |> 
    select(ine,Municipio, `2024`) # Se seleccionan los DATOS DE 2024

ods11.despobl <- dens24 |> 
  rename(Densidad= `2024`) |> 
  select(3,1,2) |> 
  mutate(Densidad= as.integer(Densidad),
         ods11.despobl= ifelse(12.5-Densidad<=0,0,
                              (12.5-Densidad)/12.5))

despobl_sf <- mun_sf |> inner_join(ods11.despobl, by= c("MUNIINE"= "ine"))

tm_shape(despobl_sf)+
    tm_fill(col= "ods11.despobl",
            id="Municipio",
            #style = "quantile",
            #n=5,
            #breaks = c(0,.5,2,21.4),
            palette = c("white","darkred"),
            title = "Índice de despoblación",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Índice de despoblación: "= "ods11.despobl",
                         "Densidad (hab./km2)"= "Densidad"),
            popup.format = list(ods11.despobl= list(decimal.mark = ","),
                                Densidad= list(big.mark= "."))) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```

# ODS12 - Producción y consumo responsables

## Column {.tabset}

### Recogida selectiva de envases ligeros <br> <d style= "font-size: 10px;">Recogida selectiva (kg/hab.) de envases ligeros <br> (contenedor amarillo)</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos recopilados del buscador de <br> Recogida de envases por localidades de ECOEMBES (2023)</i></c>

```{r}

# Lectura datos, filtrado año 2023, recogida BBDD Amarillo, La unida de de gestión es un ayuntamiento

ecoembesAl <- read_xlsx("BasesdeDatos/ODS12/ecoembesAl.xlsx")
ecoembesCas <- read_xlsx("BasesdeDatos/ODS12/ecoembesCas.xlsx")
ecoembesVal <- read_xlsx("BasesdeDatos/ODS12/ecoembesVal.xlsx")

recogida <- rbind(ecoembesAl,ecoembesCas,ecoembesVal)

recogidaClean <- recogida |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= str_remove(Municipio, " alicante"),
           Municipio= str_remove(Municipio, " valencia"),
           Municipio= str_remove(Municipio, " castellon"),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_when(#Municipio== "ador valencia"~ "ador",
                                Municipio== "alfas del pi"~ "alfas del pi l",
                                Municipio== "algimia de alfara"~ "algimia dalfara",
                                Municipio== "adsubia"~ "atzubia l",
                                Municipio== "alboraya"~ "alboraia/alboraya",
                                Municipio== "alcora"~ "alcora l",
                                Municipio== "alcocer de planes"~"alcosser",
                                Municipio== "alfarp"~ "alfarb",
                                Municipio== "alfas del pi alicante"~ "alfas del pi l",
                                Municipio== "alicante"~ "alicante/alacant",
                                Municipio== "almazora/almassora"~ "almassora",
                                Municipio== "alqueria de la condesa/alqueria de la comtessa l"~
                                    "alqueria de la comtessa l",
                                Municipio== "alquerias del nino perdido"~ 
                                    "alqueries les/alquerias del nino perdido",
                                #Municipio== "altea alicante"~ "altea",
                                Municipio== "ares del maestre"~ "ares del maestrat",
                                Municipio== "benasal"~ "benassal",
                                Municipio== "benicassim"~ "benicasim/benicassim",
                                Municipio== "beniparrel"~ "beniparrell",
                                Municipio== "benisoda"~ "benissoda",
                                Municipio== "benisano"~ "benissano",
                                Municipio== "benisuera"~ "benissuera",
                                Municipio== "benlloch"~ "benlloc",
                                Municipio== "borriol castellon"~ "borriol",
                                Municipio== "burjassot valencia"~ "burjassot",
                                Municipio== "burriana"~ "borriana/burriana",
                                Municipio== "callosa dsarria"~ "callosa den sarria",
                                Municipio== "calpe/calp"~ "calp",
                                Municipio== "campello"~ "campello el",
                                Municipio== "caned denberenguer valencia"~ "canet den berenguer",
                                Municipio== "castellon de la plana"~ "castello de la plana",
                                Municipio== "castellon de la plana/castello de la plana"~ 
                                    "castello de la plana",
                                Municipio== "chert/xert"~ "xert",
                                Municipio== "chilches"~ "chilches/xilxes",
                                Municipio== "crevillente"~ "crevillent",
                                Municipio== "elche"~ "elche/elx",
                                Municipio== "genoves"~ "genoves el",
                                Municipio== "guadalest"~ "castell de guadalest el",
                                Municipio== "guadasequies"~ "guadassequies",
                                Municipio== "guardamar"~ "guardamar de la safor",
                                Municipio== "herbes"~ "herbers",
                                Municipio== "hondon de las nieves"~ 
                                    "fondo de les neus el/hondon de las nieves",
                                Municipio== "jalon/xalo"~ "xalo",
                                Municipio== "jativa"~ "xativa",
                                Municipio== "javea"~ "javea/xabia",
                                Municipio== "alcudia / lalcudia la"~ "alcudia l",
                                Municipio== "eliana/leliana la"~ "eliana l",
                                Municipio== "facheca"~ "fageca",
                                Municipio== "pobla de tornesa la"~ "pobla tornesa la",
                                Municipio== "torre de macanes la"~ 
                                    "torremanzanas/torre de les macanes la",
                                Municipio== "llosa de ranes"~ "llosa de ranes la",
                                Municipio== "masalaves"~ "massalaves",
                                Municipio== "massanassa valencia"~ "massanassa",
                                # Municipio== "meliana valencia"~ "meliana",
                                Municipio== "monovar"~ "monovar/monover",
                                Municipio== "monserrat"~ "montserrat",
                                Municipio== "novele/novetle"~ "novetle",
                                Municipio== "oropesa"~ "oropesa del mar/orpesa",
                                Municipio== "peniscola"~ "peniscola/peniscola",
                                Municipio== "pinoso"~ "pinos el/pinoso",
                                Municipio== "poble nou de benitatxell"~
                                    "benitachell/poble nou de benitatxell el",
                                Municipio== "poblets"~ "poblets els",
                                Municipio== "polop de la marina"~ "polop",
                                Municipio== "puig"~ "puig de santa maria el",
                                Municipio== "rafelbunol/rafelbunyol"~ "rafelbunyol",
                                Municipio== "real de gandia"~ "real de gandia el",
                                Municipio== "real de montroi"~ "real",
                                Municipio== "rotgla y corbera"~ "rotgla i corbera",
                                Municipio== "sagunto"~ "sagunto/sagunt",
                                Municipio== "san jorge"~ "sant jordi/san jorge",
                                Municipio== "san juan de enova"~ "sant joanet",
                                Municipio== "san juan de moro"~ "sant joan de moro",
                                Municipio== "san vicente de raspeig"~ 
                                    "san vicente del raspeig/sant vicent del raspeig",
                                Municipio== "sarratella"~ "serratella la",
                                Municipio== "sierra-engarceran"~ "sierra engarceran",
                                Municipio== "torre endomenech"~ "torre den domenec la",
                                Municipio== "useras"~ "useras/useres les",
                                Municipio== "vall de ebo"~ "vall debo la",
                                Municipio== "vall de gallinera"~ 
                                    "vall de gallinerala",
                                Municipio== "villajoyosa"~ "villajoyosa/vila joiosa la",
                                Municipio== "villalonga"~ "vilallonga/villalonga",
                                Municipio== "villanueva de"~ "castello",
                                Municipio== "villarreal/vila-real"~ "vila-real",
                                Municipio== "villavieja"~ "vilavella la",
                                Municipio== "vistabella del maestrazgo"~ 
                                    "vistabella del maestrat",
                                .default = as.character(Municipio)))

ods12.envases <- recogidaClean |> 
    left_join(munClean, by= "Municipio") |> 
    select(4,2)

ods12.envases.hab <- municipios[, c(1,2)] |> 
    left_join(ods12.envases, by= 'ine') |> 
    rename(ods12.envases.hab= Envases.Lig)
    

ods12.envases.hab_sf <- mun_sf |> left_join(ods12.envases.hab, by= c("MUNIINE"= "ine"))


tm_shape(ods12.envases.hab_sf)+
    tm_fill(col= "ods12.envases.hab",
            id="Municipio",
            #style = "quantile",
            n=6,
            breaks = c(0,10,20,30, 40, 100),
            palette = c("white","darkgreen"),
            title = "Cantidad de envases recogidos <br> por habitante (kg/hab.)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Envases recogidos por habitante (Kg/hab.): "= "ods12.envases.hab"),
            popup.format = list(ods12.envases.hab= list(decimal.mark = ",",
                                                        digits= 1))
            )+
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```

### Recogida selectiva de papel y cartón <br> <d style= "font-size: 10px;">Recogida selectiva (kg/hab.) de papel y cartón (contenedor azul)</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos recopilados del buscador de <br> Recogida de envases por localidades de ECOEMBES (2023)</i></c>

```{r}

ods12.papel <- recogidaClean |> 
    left_join(munClean, by= "Municipio") |> 
    select(4,3) |> 
    rename(ods12.papel.hab= Papel.Cart)

ods12.papel.hab <- municipios[, c(1,2)] |> left_join(ods12.papel, by= 'ine')

ods12.papel.hab_sf <- mun_sf |> inner_join(ods12.papel.hab, by= c("MUNIINE"= "ine"))


tm_shape(ods12.papel.hab_sf)+
    tm_fill(col= "ods12.papel.hab",
            id="Municipio",
            #style = "quantile",
            n=6,
            breaks = c(0,10,20,30, 40, 100),
            palette = c("white","darkgreen"),
            title = "Cantidad de papel y cartón recogidos <br> por habitante (kg/hab.)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Papel y cartón recogidos por habitante (Kg/hab.): "= "ods12.papel.hab"),
            popup.format = list(ods12.papel.hab= list(decimal.mark = ",",
                                                        digits= 1))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```

## Column {.tabset}

### Recogida selectiva de vidrio  <br> <d style= "font-size: 10px;">Recogida selectiva (kg/hab.) de vidrio (contenedor verde)</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos de ECOVIDRIO (2023)</i></c>



```{r}
vidrio <- read_xlsx("BasesdeDatos/ODS12/vidrio.xlsx")

vidrioClean <-vidrio |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_when(Municipio== "alcocer de planes"~ "alcosser",
                                Municipio== "facheca"~ "fageca",
                                Municipio== "vall de gallinera"~ "vall de gallinera la",
                                Municipio== "benlloch"~ "benlloc",
                                Municipio== "castellon de la plana/castello de la plana"~ 
                                    "castello de la plana",
                                Municipio== "alfas del pi"~ "alfas del pi l",
                                Municipio== "alfarp" ~ "alfarb",
                                Municipio== "adsubia-forna"~ "atzubia l",
                                Municipio== "alboraya"~ "alboraia/alboraya",
                                Municipio== "alcora"~ "alcora l",
                                Municipio== "alfas del pi alicante"~ "alfas del pi l",
                                Municipio== "algue?a"~ "alguena",
                                Municipio== "alicante"~ "alicante/alacant",
                                Municipio== "almazora/almassora"~ "almassora",
                                Municipio== "alquerias del nino perdido"~ 
                                    "alqueries les/alquerias del nino perdido",
                                #Municipio== "altea alicante"~ "altea",
                                Municipio== "benicassim"~ "benicasim/benicassim",
                                Municipio== "beniparrel"~ "beniparrell",
                                Municipio== "benisano"~ "benissano",
                                Municipio== "benlloch"~ "benlloc",
                                Municipio== "borriol castellon"~ "borriol",
                                Municipio== "burjassot valencia"~ "burjassot",
                                Municipio== "burriana"~ "borriana/burriana",
                                Municipio== "callosa dsarria"~ "callosa den sarria",
                                Municipio== "calpe"~ "calp",
                                Municipio== "campello"~ "campello el",
                                Municipio== "caned denberenguer valencia"~ "canet den berenguer",
                                Municipio== "caned denberenguer"~ "canet den berenguer",
                                Municipio== "castellon de la plana"~ "castello de la plana",
                                Municipio== "chilches"~ "chilches/xilxes",
                                Municipio== "crevillente"~ "crevillent",
                                Municipio== "elche"~ "elche/elx",
                                Municipio== "hondon de las nieves"~ 
                                    "fondo de les neus el/hondon de las nieves",
                                Municipio== "jalon"~ "xalo",
                                Municipio== "jativa"~ "xativa",
                                Municipio== "javea"~ "javea/xabia",
                                Municipio== "alcudia / lalcudia la"~ "alcudia l",
                                Municipio== "eliana/leliana la"~ "eliana l",
                                Municipio== "pobla de tornesa la"~ "pobla tornesa la",
                                Municipio== "torre de macanes la"~ 
                                    "torremanzanas/torre de les macanes la",
                                Municipio== "masalaves"~ "massalaves",
                                Municipio== "massanassa valencia"~ "massanassa",
                                # Municipio== "meliana valencia"~ "meliana",
                                Municipio== "monovar"~ "monovar/monover",
                                Municipio== "monserrat"~ "montserrat",
                                Municipio== "novele/novetle" ~ "novetle",
                                Municipio== "oropesa"~ "oropesa del mar/orpesa",
                                Municipio== "peniscola"~ "peniscola/peniscola",
                                Municipio== "pinoso"~ "pinos el/pinoso",
                                Municipio== "poble nou de benitatxell"~
                                    "benitachell/poble nou de benitatxell el",
                                Municipio== "poblets"~ "poblets els",
                                Municipio== "polop de la marina"~ "polop",
                                Municipio== "real de gandia"~ "real de gandia el",
                                Municipio== "sagunto"~ "sagunto/sagunt",
                                Municipio== "san jorge"~ "sant jordi/san jorge",
                                Municipio== "san juan de moro"~ "sant joan de moro",
                                Municipio== "san vicente de raspeig"~ 
                                    "san vicente del raspeig/sant vicent del raspeig",
                                Municipio== "sarratella"~ "serratella la",
                                Municipio== "sierra-engarceran"~ "sierra engarceran",
                                Municipio== "torre endomenech"~ "torre den domenec la",
                                Municipio== "useras"~ "useras/useres les",
                                Municipio== "villajoyosa"~ "villajoyosa/vila joiosa la",
                                Municipio== "villalonga"~ "vilallonga/villalonga",
                                Municipio== "villavieja"~ "vilavella la",
                                Municipio== "xodos"~ "chodos/xodos",
                                Municipio== "herbes"~ "herbers",
                                Municipio== "villafranca del cid/vilafranca"~
                                    "vilafranca/villafranca del cid",
                                Municipio== "algimia de alfara"~ "algimia dalfara",
                                Municipio== "genoves"~ "genoves el",
                                Municipio== "naquera"~ "naquera/naquera",
                                Municipio== 
                                    "vall de gallinera la"~ "vall de gallinerala",
                                Municipio== "villanueva de castellon"~ "castello",
                                .default = as.character(Municipio)))

ods12.vidrio <- vidrioClean |> 
    left_join(munClean, by= "Municipio") %>% 
    mutate(ine= ifelse(is.na(ine), "03136", ine)) # Afegim manualment aquest codi


# En este caso el dato no viene en kg/hab, por lo tanto hay que clcularlo en base a la población de 2023

ods12.vidrio.hab <- municipios_23 |> 
    inner_join(ods12.vidrio[, c(4,5)], by= "ine") |> 
    rename(ods12.vidrio = Envases.de.vidrio..kgs..recogidos,
           Poblacion2023= `2023`) |> 
    mutate(ods12.vidrio.hab= round(ods12.vidrio / Poblacion2023,1),
           tonas.vidrio= round(ods12.vidrio/1000,1))

ods12.vidrio.hab_sf <- mun_sf |> left_join(ods12.vidrio.hab, by= c("MUNIINE"= "ine"))


tm_shape(ods12.vidrio.hab_sf)+
    tm_fill(col= "ods12.vidrio.hab",
            id="Municipio",
            #style = "quantile",
            n=6,
            breaks = c(0,10,20,30, 40, 120),
            palette = c("white","darkgreen"),
            title = "Cantidad de vidrio recogido <br> por habitante (kg/hab.)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Vidrio recogido por habitante (Kg/hab.): "= "ods12.vidrio.hab"),
            popup.format = list(ods12.vidrio.hab= list(decimal.mark = ",",
                                                        digits= 1))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)




```

### Ecoparques en el municipio <br> <d style= "font-size: 10px;">Presencia de ecoparques en el territorio municipal</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos recopilados del "Buscador <br> de productores y gestores de residuos" de la GVA (2025)</i></c>

```{r}

# Lectura del datasets obtenido en la página: https://residuos.gva.es/RES_BUSCAWEB/buscador_residuos_avanzado.aspx?idioma=C

ecoparques <- read_xlsx("BasesdeDatos/ODS12/ecoparques.xlsx")

ecoparquesClean <- ecoparques |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both"))

ecoparquesIne <- ecoparquesClean[, c(2,6)] |> 
    left_join(munClean, by= c('Municipio')) |> 
    distinct(ine,Municipio)


ods12.ecoDef <- municipios[, c(1,2)] |> 
    left_join(ecoparquesIne, by= "ine") |> 
    mutate(ods12.ecoparque= ifelse(is.na(Municipio.y), "No", "Sí")) |> 
    select(1,2,4) |> 
    rename(Municipio=Municipio.x)

ods12.eco_sf <- mun_sf |> inner_join(ods12.ecoDef, by= c("MUNIINE"= "ine"))

tm_shape(ods12.eco_sf)+
    tm_fill(col= "ods12.ecoparque",
            id="Municipio",
            #style = "quantile",
            #n=6,
            #breaks = c(0,10,20,30, 40, 117),
            palette = c("white","#3BB143"),
            title = "Ecoparques en el municipio",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("El municipio dispone de un ecoparque: "= "ods12.ecoparque")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```

# ODS13: Acción por el clima

## Column {.tabset}

### Participación en compromisos internacionales por el clima <br> <d style= "font-size: 10px;">Participación al Global Covenant of Mayors for Climate & Energy</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos de las bases de datos de la UE de proyectos y firmantes del GC of Mayors (2023)</i></c>

```{r}


datosGC <- read_xlsx("BasesdeDatos/ODS13/datosGlobalCoventant.xlsx")

ods13.GCM <- municipios[, c(1,2)] |> 
    left_join(datosGC, by= "ine") |> 
    mutate(ods13.Participa= ifelse(is.na(Municipio.y), "No", "Sí"))

ods13.GCM_sf <- mun_sf |> inner_join(ods13.GCM, by= c("MUNIINE"="ine"))

tm_shape(ods13.GCM_sf)+
    tm_fill(col= "ods13.Participa",
            id="Municipio.x",
            #style = "quantile",
            #n=2,
            breaks = c(0,1),
            palette = c("white","#3BB143"),
            title = "Participación en el Global Coventant",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("El ayuntamiento participa en el Gobal Covenant: "= "ods13.Participa")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```


# ODS15 - Vida de ecosistemas terrestres

## Column

### Tasa de ocupación de bosques <br> <d style= "font-size: 10px;">Tasa se superficie municipal ocupada por bosques de especies maderables de crecimiento lento</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos cadastrales publicados (2024)</i></c>

```{r}

# DF de datos preprocesados de superficies municipales totales obtenidos de
# https://bdt.gva.es/bdt/

supMuni <- read_xlsx("BasesdeDatos/ODS15/supMunicipios.xlsx")

#====================================================
# La superficie rústica es importante para calcular la superfície de bosque en valores absolutos que el cadastro facilita en % sobre la superficie rústica

# Datos catastrales obtenidos en: 
# https://www.catastro.hacienda.gob.es/esp/estadistica_10.asp

# Superficie rústica en has.

rustAl <- read_xls("BasesdeDatos/ODS15/pcaxis987770508_RusticaAlicante.xls", 
                   skip = 5) |> 
    filter(grepl("^03", ...1)) |> 
    rename(Municipio= ...1)
rustCas <- read_xls("BasesdeDatos/ODS15/pcaxis1849262700_RusticaCastellon.xls",
                    skip = 5) |> 
    filter(grepl("^12", ...1)) |> 
    rename(Municipio= ...1)
    
rustVal <- read_xls("BasesdeDatos/ODS15/pcaxis-486724903_RusticaValencia.xls",
                   skip = 5) |> 
    filter(grepl("^46", ...1)) |> 
    rename(Municipio= ...1)

supRustica <- rbind(rustAl,rustCas,rustVal) |> 
    rename(supRusticaHa= `Superficie rústica`) |> 
    mutate(ine= str_sub(Municipio, 1,5),
           Municipio= str_sub(Municipio, 7,100)) |> 
    select(3,1,2) |> 
    mutate(supRusticaHa = str_remove(supRusticaHa,"\\."),
           supRusticaHa= gsub(",", "\\.", supRusticaHa)) |> 
    mutate(supRusticaHa= as.numeric(supRusticaHa))

# Superficie de bosque de especies maderables de crecimiento lento en % sobre la superfície rústica total


bosqAl <- read_xls("BasesdeDatos/ODS15/pcaxis-2129969910_BosqueAlicante.xls", 
                   skip = 5) |> 
    filter(grepl("^03", ...1)) |> 
    rename(Municipio= ...1)

bosqCas <- read_xls("BasesdeDatos/ODS15/pcaxis-2075646884_BosqueCastellon.xls",
                    skip = 5) |> 
    filter(grepl("^12", ...1)) |> 
    rename(Municipio= ...1)
    
bosqVal <- read_xls("BasesdeDatos/ODS15/pcaxis1303917253_BosqueValencia.xls",
                   skip = 5) |> 
    filter(grepl("^46", ...1)) |> 
    rename(Municipio= ...1)

bosque <- rbind(bosqAl,bosqCas,bosqVal) |> 
    rename(tasaSupBosq= `Especies maderables de crecimiento lento`) |> 
    mutate(ine= str_sub(Municipio, 1,5),
           Municipio= str_sub(Municipio, 7,100)) |> 
    select(3,1,2) |> 
    mutate(tasaSupBosq= gsub(",", "\\.", tasaSupBosq)) |> 
    mutate(tasaSupBosq= as.numeric(tasaSupBosq)) # La tasa es sobre la superficie rústica total

# Cálculo % de sup. de posque sobre supefície total del municipio

ods15.tasaBosque <- supMuni |> 
    inner_join(supRustica[, c(1,3)], by= 'ine') |> 
    inner_join(bosque[, c(1,3)], by= 'ine') |> 
    mutate(supMunHa= supKm2*100,
           supBosque= round(supRusticaHa*tasaSupBosq/100,2),
           ods15.tasaBosque= round(supBosque/supMunHa*100,1))

ods15.tasaBosque_sf <- mun_sf |> 
    inner_join(ods15.tasaBosque[, c(1,2,3,7,8)], by= c("MUNIINE"="ine"))


tm_shape(ods15.tasaBosque_sf)+
    tm_fill(col= "ods15.tasaBosque",
            id="Municipio",
            #style = "quantile",
            #n=6,
            #breaks = c(0,10,20,30, 40, 117),
            palette = c("white","darkgreen"),
            title = "Tasa de superficie de bosque sobre <br> superficie total (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Superficie de bosque sobre supeficie total (%): "= "ods15.tasaBosque",
                         "Superficie de bosque en Ha"= "supBosque",
                         "Superfície municipal en Km2"= "supKm2"),
            popup.format = list(ods15.tasaBosque= list(decimal.mark = ","),
                                supBosque= list(big.mark= ".",
                                                    decimal.mark= ","),
                                supKm2= list(big.mark= ".",
                                             decimal.mark= ","))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE) 




```


## Column

### Espacios naturales protegidos <br> <d style= "font-size: 10px;">Número de espacios naturales con alguna protección en el territorio municipal</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos del IVE (2021)</i></c>

```{r}

# Lectura datos obtenidos en https://bdt.gva.es/bdt/ y preprocesados

ods15.espNat <- read_xlsx("BasesdeDatos/ODS15/espaciosProtegidos.xlsx")

ods15.espNat_sf <- mun_sf |> inner_join(ods15.espNat, by= c("MUNIINE"="ine"))


tm_shape(ods15.espNat_sf)+
    tm_fill(col= "ods15.espNat",
            id="Municipio",
            #style = "quantile",
            n=5,
            breaks = c(0,1,5,10, 20),
            palette = c("white","darkgreen"),
            title = "Espacios naturales en el territorio municipal",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Espacios naturales en el territorio municiapal: "= "ods15.espNat"),
            
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```



# ODS16 - Paz, justicia e instituciones sólidas

## Column

### Tasa de criminalidad general, excluyendo Cibercriminalidad <br> <d style= "font-size: 10px;">Tasa de delitos registrados por 10.000 habitantes</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos de criminalidad del Ministerio de Interior (2024)</i></c>

```{r}

# Datos de crmiminalidad de 2024 obtenidos en https://estadisticasdecriminalidad.ses.mir.es/publico/portalestadistico/balances.html y procesados

criminalidad <- read_xlsx("BasesdeDatos/ODS16/criminalidad.xlsx") 
    
ods16.crimConv <- municipios_24 |> 
    left_join(criminalidad[,-2], by= 'ine') |>
    rename(ods16.crimConv= Crim.Convencional.2024,
           Total= `2024`) |> # Población del Municipio
    mutate(ods16.tasaCrimConv= round(ods16.crimConv/Total*10000,2)) # Calculo tasa/10.000 hab.

ods16.crimConv_sf <- mun_sf |> inner_join(ods16.crimConv, by= c("MUNIINE"= "ine"))


tm_shape(ods16.crimConv_sf)+
    tm_fill(col= "ods16.tasaCrimConv",
            id="Municipio",
            #style = "quantile",
            n=5,
            breaks = c(100,300,500,700, 900),
            palette = c("papayawhip","darkred"),
            title = "Tasa de criminalidad convencional / 10.000 hab.",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de criminalidad convencional/10.000 hab.: "= "ods16.tasaCrimConv",
                         "Número de crímenes convencionales: "= "ods16.crimConv"),
             popup.format = list(ods16.tasaCrimConv= list(decimal.mark = ","),
                                ods16.crimConv= list(big.mark= "."))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```


## Column

### Tasa de homicidios y tentativas de homicidio <br> <d style= "font-size: 10px;">Tasa de delitos registrados por 10.000 habitantes</d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos de criminalidad del Ministerio de Interior (2024)</i></c>

```{r}

homicidios <- read_xlsx("BasesdeDatos/ODS16/homicidis.xlsx")

tasaHomic <- homicidios %>% 
    mutate(homTot= Homicidios + Intentos) %>%
    select(-2) %>% 
    inner_join(municipios_24, by= "ine") %>% 
    rename(Total= `2024`) %>%  # Población total municipio 2024
    mutate(ods16.tasaTotHom= round(homTot/Total*10000,2)) %>% # Calcular tasa hom./10.000 hab.
    select(1,5,6, 2:4,7)

ods16.tasaHomic <- municipios[, 1:2] |> left_join(tasaHomic, by= 'ine')

ods16.tasaHomic_sf <- mun_sf |> inner_join(ods16.tasaHomic, by= c("MUNIINE"="ine"))

tm_shape(ods16.tasaHomic_sf)+
    tm_fill(col= "ods16.tasaTotHom",
            id="Municipio.x",
            #style = "quantile",
            #n=5,
            #breaks = c(100,300,500,700, 900),
            palette = c("papayawhip","darkred"),
            title = "Tasa de homicidios y tentativas <br> de homicidio / 10.000 hab.",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("Tasa de homic. y tentativas /10.000 hab.: "= "ods16.tasaTotHom",
                         "Número de homic. y tentativas: "= "homTot"),
             popup.format = list(ods16.tasaTotHom= list(decimal.mark = ","),
                                homTot= list(big.mark= "."))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)



```


# ODS17 - Alianzas para lograr los objetivos

## Column

### Miembros de la Red de Ciudades Educadoras <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos recopilados de la  página web de AICE-Asociación Internacional de Ciudades Educadoras</i></c>

```{r}

# Lectura DF de datos recopilados en 'https://www.edcities.org/listado-de-las-ciudades-asociadas/

ciudEd <- read_xlsx("BasesdeDatos/ODS17/CiudadesEducadoras.xlsx")

ods17.ciudEd <- municipios[, c(1,2)] |> left_join(ciudEd, by= 'ine') |> 
    mutate(ods17.ciudEd= ifelse(is.na(Municipio.y), "No", "Sí")) |> 
    rename(Municipio= Municipio.x) |> 
    select(1,2,4)

ods17.ciudEd_sf <- mun_sf |> inner_join(ods17.ciudEd, by= c("MUNIINE"= "ine"))

tm_shape(ods17.ciudEd_sf)+
    tm_fill(col= "ods17.ciudEd",
            id="Municipio",
            #style = "quantile",
            #n=2,
            breaks = c(0,1),
            palette = c("white","#3BB143"),
            title = "Miembro de AICE-Asociación Internacional <br> de Ciudades Educadoras",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("El ayuntamiento es miembro de AICE: "= "ods17.ciudEd")) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)

```

## Column

### Tasa de presupuesto dedicado a Cooperacion Internacional (%) <br> <d style= "font-size: 10px;">% de Presupuesto dedicado a Cooperación Internacional sobre Ingresos propios del Ayuntamiento (2021) </d> <br> <c style= "font-size: 10px;"><i>Elaboracion propia sobre datos facilitados por el Fons Valencià per la Solidaritat, completados por datos recopilados <br> del buscador de proyectos de la FEMPE y datos del Ministerio de Economía y Función Pública</i></c>

```{r}

# Lectura datos ingresos propios municipios del año 2021 (preprocesados: ver ODS 17)
ingrPropios21 <- read_xlsx("BasesdeDatos/ODS17/Liquidaciones2021/ingresosPropio2021.xlsx") |> 
    distinct(ine, .keep_all = TRUE) |> 
    select(1,2,10)

# Lectura datos Fons Valencià y limpieza para Join
datosFons <- read_xlsx("BasesdeDatos/ODS17/Pressupost Socis Fons.xlsx") |> 
    rename(Municipio= Nombre,
           coop.21= `coop 2021`) |> 
    select(1,8) |> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_match(Municipio,
                                 "benifairo dels valls"~ "benifairo de les valls",
                                 "villanueva de castellon"~ "castello",
                                 .default = as.character(Municipio)))

# Lectura datos FEMP y limpieza para Join
datosFEMP <- read_xlsx("BasesdeDatos/ODS17/coop.municipios2021.xlsx") |> 
#    pivot_wider(names_from = Concepto, values_from = Importe) |> 
#    select(1,2,3) |> 
#    mutate(`Total comprometido`= gsub("\\.", "",`Total comprometido`),
#           `Total comprometido`= as.numeric(gsub(",","\\.",`Total comprometido`)),
#           `Presupuesto de cooperación`= gsub("\\.", "",`Presupuesto de cooperación`),
#           `Presupuesto de cooperación`= as.numeric(gsub(",","\\.",
#                                                         `Presupuesto de cooperación`))) #|> 
    mutate(Municipio= tolower(Municipio),
           Municipio= stringi::stri_trans_general(Municipio, "Latin-ASCII"),
           Municipio= sub("^l'(.*)", "\\1 l'", Municipio),
           Municipio= gsub("'", "", Municipio),
           Municipio= gsub("`", "", Municipio),
           Municipio= gsub("´","", Municipio),
           Municipio= gsub(",", "", Municipio),
           Municipio= gsub("\\(", "", Municipio),
           Municipio= gsub(")", "", Municipio),
           Municipio= sub("^la (.*)", "\\1 la", Municipio),
           Municipio= sub("^el (.*)", "\\1 el", Municipio),
           Municipio= sub("^les (.*)", "\\1 les", Municipio),
           Municipio= sub("^los (.*)", "\\1 los", Municipio),
           Municipio= trimws(Municipio, "both")) |> 
    mutate(Municipio= case_when(Municipio== "castellon de la plana/castello de la plana"~
                                    "castello de la plana",
                                .default = as.character(Municipio)))



# Fusión datos FEMP con mnombres municipios
coopFEMP <- datosFEMP |> 
    left_join(munClean, by= "Municipio") |> 
    select(4,1,2,3)

# Fusión datos Fons con nombres municipios
coopFons <- datosFons |> 
    left_join(munClean, by= "Municipio") |> 
    filter(!is.na(coop.21) & !is.na(ine))

# Fusión de las dos tablas: la columna coop.21, si tiene dato se mantiene, si no, se aprovecha dato de la columna "Total comprometido".

coopCVA21 <- coopFEMP[,-3] |> # En relación a 2021, faltan los municipios de Agost, Barxeta y Paiporta
    full_join(coopFons, by= 'ine') |> 
    mutate(coop.21= ifelse(is.na(coop.21), Importe, coop.21)) %>% 
    select(1,5) %>% 
    filter(!is.na(coop.21))



coopCVA21 <- ingrPropios21 |> 
    inner_join(coopCVA21, by= "ine") |> 
    mutate(ods17.tasaCoop= round(coop.21/ingPropios21*100,2))

ods17.coop <- municipios[, c(1,2)] |> left_join(coopCVA21[, c(1,4,5)])

ods17.coop_sf <- mun_sf |> inner_join(ods17.coop, by= c("MUNIINE"= "ine"))

tm_shape(ods17.coop_sf)+
    tm_fill(col= "ods17.tasaCoop",
            id="Municipio",
            #style = "quantile",
            #n=6,
            #breaks = c(0,10,20,30, 40, 117),
            palette = c("lightgreen","darkgreen"),
            title = "Presupuesto destinado a cooperación sobre <br> ingresos directos del ayuntamiento (%)",
            legend.format = list(text.separator= '-',
                                 decimal.mark= ","),
            textNA = 'Valor ausente',
            popup.vars=c("% de Presupuesto destinado a cooperación: "= "ods17.tasaCoop",
                         "Presupuesto destinado a cooperación (€)"= "coop.21"),
            popup.format = list(ods17.tasaCoop= list(decimal.mark = ",",
                                                     digits= 2),
                                coop.21= list(big.mark= ".",
                                              decimal.mark= ","))
            ) +
    tm_borders(col="gray30",lwd=0.5)+
    tm_shape(prov_sf) +
  # Change col and lwd of neighborhood boundaries
    tm_borders(col="grey40", lwd=2)+
    tmap_options(check.and.fix = TRUE)


```




# Resúmenes y descargas

## Column {.tabset}

### Panel de índices integrados por ODS

```{r}


resum <- municipios_24 |> rename(Total= `2024`) |> 
    left_join(pobr[, c(1,3,4)], by= 'ine') |> 
    left_join(pInf[ , c(1,3), by='ine']) |> 
    left_join(desp23Val[, c(1,5)], by= 'ine') |> 
    left_join(ods2.nivPriv[, c(1,11)], by= 'ine') |> 
    mutate(ods2.nivPriv= case_match(
        ods2.nivPriv,
        "Tasa baja: menos de 4.41"~ 1,
        "Tasa medio-baja: 4.41-7.41%"~ 2,
        "Tasa medio-alta: 7.41-10.5"~ 3,
        "Tasa alta: más de 10.5%"~ 4)) |> 
    left_join(tasaMP[ ,c(1,5 )], by= 'ine') |> 
    left_join(edadMort[c(1,3)], by = 'ine') |> 
    left_join(ods3.suic23[, c(1,5)], by= 'ine') |> 
    left_join(ods3.infarto[,c(1,5)], by= 'ine') |> 
    left_join(eduNivel[,c(1,5)], by= 'ine') |> 
    left_join(desp32Val[ ,c(1,5)], by= 'ine') |> 
    left_join(ods4.epd[, c(1,4)], by= 'ine') |> 
    left_join(dfviol[, c(1,6)], by = 'ine') |> 
    left_join(ods5.RVI[, c(1,4)], by= 'ine') |> 
    left_join(ods6.vulnerNitr[, c(1,5)]) |> 
    left_join(nivPobrEn[, c(1,6)], by= 'ine') |> 
    left_join(tasaParo[, c(1,5)], by= 'ine') |> 
    left_join(ods8.paroJuv[, c(1,5)], by= 'ine') |> 
    left_join(ods10.tasa_50[, c(1,3)], by= 'ine') |> 
    left_join(ods10.Gini[, c(1,3)], by= 'ine') |> 
    left_join(ods10.Dep[, c(1,7)], by= 'ine') |> 
    left_join(ods11.vulner[, c(1,5)], by= 'ine') |> 
    left_join(ods11.PM10sup, by= 'ine') |> 
    left_join(ods11.despobl[, c(2,4)], by ='ine') |> 
    left_join(ods12.envases.hab[, c(1,3)], by= 'ine') |> 
    left_join(ods12.papel.hab[, c(1,3)], by= 'ine') |> 
    left_join(ods12.vidrio.hab[, c(1,5)], by= 'ine') |> 
    left_join(ods12.ecoDef[, c(1,3)], by= 'ine') |> 
    left_join(ods13.GCM[, c(1,4), by= 'ine']) |> 
    left_join(ods15.tasaBosque[, c(1,8)], by= 'ine') |> 
    left_join(ods15.espNat[, c(1,3)], by= 'ine') |> 
    left_join(ods16.crimConv[, c(1,5)], by= 'ine') |> 
    left_join(ods16.tasaHomic[, c(1,8)]) |> 
    left_join(ods17.ciudEd[, c(1,3)]) |> 
    left_join(ods17.coop[, c(1,4)])



```



```{=html}
<style>
  .superbigimage{
      overflow-y:scroll;
      white-space: nowrap;
  }


</style>
```
::: superbigimage
```{r fig.height=20, fig.width=10}


index <- resum  |> 
    filter(Total >= 20000) |> 
    mutate(ods4.epdSi= ifelse(ods4.epdSi== 'No', 0, 1)) |> 
    mutate(ods5.rvi= ifelse(ods5.rvi== 'No', 0, 1)) |> 
    mutate(ods12.ecoparque= ifelse(ods12.ecoparque== 'No', 0, 1)) |> 
    mutate(ods13.Participa= ifelse(ods13.Participa== 'No', 0, 1)) |> 
    mutate(ods17.ciudEd= ifelse(ods17.ciudEd== 'No', 0, 1)) |>
    mutate(across(starts_with('ods01'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods2'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods3'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods4'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods5'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods6'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods7'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods8'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods10'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods11'), 
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods12'),
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods13'),
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods15'),
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods16'),
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(starts_with('ods17'),
                ~ (.x - min(na.omit(.)))/ (max(na.omit(.))-min(na.omit(.)))),
         across(where(~is.numeric(.)), ~ifelse(is.nan(.), 0, .))) |> 
    
        
 mutate(ods01.PobrSev = 1-ods01.PobrSev,
        ods01.Pobr = 1-ods01.Pobr,
        ods01.PobrInfantil= 1-ods01.PobrInfantil,
        ods2.nivPriv= 1-ods2.nivPriv,
        ods3.tasaMP= 1-ods3.tasaMP,
        ods3.tasaSuic= 1-ods3.tasaSuic,
        ods3.tasaInf= 1-ods3.tasaInf,
        ods5.tasaViolSex24= 1-ods5.tasaViolSex24,
        ods6.vulnerNitr= 1-ods6.vulnerNitr,
        ods7.numNivRiesVulnEn= 1-ods7.numNivRiesVulnEn,
        ods8.tasaParo= 1-ods8.tasaParo,
        ods8.tasaJuv= 1-ods8.tasaJuv,
        ods10.tasa50= 1-ods10.tasa50,
        ods10.gini= 1-ods10.gini,
        ods10.Dep= 1-ods10.Dep,
        ods11.tasaVuln= 1-ods11.tasaVuln,
        ods11.maxPM10= 1-ods11.maxPM10,
        ods11.despobl= 1-ods11.despobl,
        ods16.tasaCrimConv= 1-ods16.tasaCrimConv,
        ods16.tasaTotHom= 1-ods16.tasaTotHom)

ODSindex <- index |> 
  rowwise() |>  
  mutate('01'= mean(c_across(starts_with('ods01'))),
         '02'= mean(c_across(starts_with('ods2'))),
         '03'= mean(c_across(starts_with('ods3'))),
         '04'= mean(c_across(starts_with('ods4'))),
         '05'= mean(c_across(starts_with('ods5'))),
         '06'= mean(c_across(starts_with('ods6'))),
         '07'= mean(c_across(starts_with('ods7'))),
         '08'= mean(c_across(starts_with('ods8'))),
         '10'= mean(c_across(starts_with('ods10'))),
         '11'= mean(c_across(starts_with('ods11'))),
         '12'= mean(c_across(starts_with('ods12'))),
         '13'= mean(c_across(starts_with('ods13'))),
         '15'= mean(c_across(starts_with('ods15'))),
         '16'= mean(c_across(starts_with('ods16'))),
         '17'= mean(c_across(starts_with('ods17'))))

ODSindex[,c(1,2,39:53)] |> 
  pivot_longer(cols = 3:17) |> 
  mutate(cat= cut(value,breaks = 4)) |> 
  mutate(Municipio= factor(Municipio,
                           levels= rev(sort(unique(Municipio))))) |> 
  ggplot(aes(x=name, y=Municipio, fill= cat))+
  geom_tile(colour= "white")+
  scale_x_discrete(position = "top") +
  scale_y_discrete(aes(reorder(desc(Municipio)))) +
  xlab('Índices integrados según ODS (municipios de más de 20.000 habitantes)') +
  geom_text(aes(label= round(value, 2)), colour="white", size=4)+
  scale_fill_manual(values = c("darkred","orange3","yellow3","green3")) +
  guides(fill= guide_legend(title = "Escala valores")) +
  theme(axis.title.x = element_text(size = 14, face = "bold", colour = "steelblue"),
        axis.title.y = element_blank())
  

```
:::



```{r}
library(downloadthis)

ODSindex[,c(1,2,38:51)] |>
download_this(
    output_name = "Indices ODS",
    output_extension = ".xls",
    button_label = "Descargar Excel",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-save",
    class= "button_large"
  )

```


```{css}
    .chart-shim {
      overflow: auto;
    }
```

```{r eval=FALSE}

# Tabla con GT

# mmtable2: ggplot2 for tables

library(gt)

resum[ , -1] |>
  gt() |> 
  tab_header('Resumen ODS por municipio') |> 
  cols_label(Municipio = 'Municipio',
             Total = 'Población',
             ods1.PobrSev = 'Pobreza Severa \n(%)',
             ods1.Pobr = 'Tasa Pobreza \n(%)',
             ods1.PobrInfantil = 'Pobr. Infantil \n(%)',
             ods1.Gasto_23perHab = 'Gasto Social \n(€/hab)',
             ods2.Perc.Afil = 'Afiliados Agr. \n(%)',
             ods2.ratioAfSau = 'Ratio Afil. / 100Ha',
             ods2.tasa.Gan= 'Ratio Intensividad Ganadería Bovina',
             ods3.tasaMP = 'Tasa Muerte Prematura',
             ods3.RatFarm= 'Farmacias / 1000 hab.',
             ods4.tasaSec = 'Educación 2ª Etapa Sec. \n(%)',
             ods4.tasaSup = 'Educación Superior \n(%)',
             ods4.tasaTot = 'Educación Sec y Sup. \n(%)') |>  
             # ods4.Gasto_32perHab = 'Gasto Mun. Educación \n(€/hab')  No se incluye de momento
  cols_align(align = 'center',
             columns = c(2:10)) |> 
  tab_spanner(label= 'ODS 1',
             columns= c(ods1.PobrSev, ods1.Pobr, ods1.PobrInfantil, ods1.Gasto_23perHab),
             id= 'ods1') |> 
  tab_spanner(label = 'ODS 2',
              columns = c(ods2.Perc.Afil,ods2.ratioAfSau, ods2.tasa.Gan),
              id= 'ods2') |> 
  tab_spanner(label = 'ODS 3',
              columns = c(ods3.tasaMP,ods3.RatFarm),
              id= 'ods3') |> 
  tab_spanner(label = 'ODS 4',
              columns = c(ods4.tasaSec,ods4.tasaSup,ods4.tasaTot),
              id= 'ods4') |> 
  tab_spanner(label = "ODS 1 y ODS 2", 
              spanners = c("ods1", "ods2")) |> 
  tab_spanner(label = "ODS 3 y ODS 4",
              spanners = c("ods3","ods4")) |> 
  opt_interactive()



```

### Listado completo

```{r}
library(DT)
resum <- resum |> 
  mutate(Ficha= paste0(ine, "-", gsub("/","-",Municipio)),
         Ficha= stringi::stri_trans_general(Ficha, "Latin-ASCII"),
         Ficha= tolower(Ficha),
         Ficha= gsub("'", "", Ficha),
         Ficha= gsub(",", "", Ficha),
         Ficha= gsub("\\(", "", Ficha),
         Ficha= gsub( ")", "", Ficha),
         Ficha= gsub(" ", "-",Ficha), .before = Municipio) |> 
    mutate(ods4.epdSi= ifelse(ods4.epdSi=='No',0,1),
           ods5.rvi= ifelse(ods5.rvi== 'No',0,1),
           ods12.ecoparque= ifelse(ods12.ecoparque== 'No',0,1),
           ods13.Participa= ifelse(ods13.Participa== 'No',0,1),
           ods17.ciudEd= ifelse(ods17.ciudEd== 'No',0,1))
         

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = 4, 'Datos generales'),
      th(colspan = 4, 'ODS 1'),
      th(colspan = 1, 'ODS 2'),
      th(colspan = 4, 'ODS 3'),
      th(colspan = 3, 'ODS 4'),
      th(colspan = 2, 'ODS 5'),
      th(colspan = 1, 'ODS 6'),
      th(colspan = 1, 'ODS 7'),
      th(colspan = 2, 'ODS 8'),
      th(colspan = 3, 'ODS 10'),
      th(colspan = 3, 'ODS 11'),
      th(colspan = 4, 'ODS 12'),
      th(colspan = 1, 'ODS 13'),
      th(colspan = 2, 'ODS 15'),
      th(colspan = 2, 'ODS 16'),
      th(colspan = 2, 'ODS 17'),
    ),
   tr(
      lapply(c('Cod. INE','Municipio','Link', 'Población',
                     'Pobreza Severa (%)',
                     'Riesgo de Pobreza (%)',
                     'Pobreza Infantil severa (%)',	
                     'Gasto Social (€/hab)', 
                     'Privación Mat. Severa (1-4)',
                     'Muerte Prematura (‰)',
                     'Edad Media Defunción (años)',
                     'Tasa suicidios (‰)',
                     'Tasa muertes infarto (‰)',
                     '2ª Etapa Educ. Secund. (%)',	
                     'Gasto MunicipaEduc. (%)',	
                     'Cobertura EPD (0=No, 1=Sí)',
                     'Delitos Sexuales (por 10.000 hab.)',
                     'Red Val. de Igualdad (0=No, 1=Sí)',
                     'Vuln. municipal nitratos en aguas (0-2)',
                     'Vulnerabil. Energética (1-4)',
                     'Desempleados / pobl. total (%)',
                     'Desempleados <25 años / pobl. 15-24 (%)',
                     'Personas debajo 50% mediana ingresos (%)',
                     'Coeficiente Gini (1-100)',
                     'Tasa de Dependencia (%)',
                     'Tasa Vulnerab. Urbana (%)',
                     'Contaminación PM10 (días > 40 μg/m3)',
                     'Índice despoblación',
                     'Recogida envases (kg/hab.)',
                     'Recogida papel/cartón (kg/hab.)',
                     'Recogida vidrio (kg/hab.)',
                     'Presencia ecoparques(0=No, 1=Sí)',
                     'Compromisos int. clima (0=No, 1=Sí)',
                     'Superficie de bosque (%)',
                     'Espacios nat. protegidos',
                     'Delitos convencionales / 10.000 hab.',
                     'Homicidios e intentos / 10.000 hab.',
                     'Ciudad educadora (0=No, 1=Sí)',
                     'Aportación a coop. al desarrollo (%)'
               ),th)
      )
   )))


resum |> 
  mutate(link = 
           paste0(
             "https://analysis.cat/cruzroja/ods/fichas/",
             Ficha,
             ".html"),
         link = map(link, ~ htmltools::a(href = .x,target="_blank", "Ver ficha")),
         link = map(link, ~ gt::html(as.character(.x))), .before = Total) |> 
  select(-2) |> 
  datatable(class = 'display',
                   extensions = 'Buttons',
                   container = sketch,
                   rownames = FALSE,
                   options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel'),
                           autoWidth= TRUE,
                           columnDefs = 
                           list(list(className = 'dt-head-center', 
                                     targets = "_all")),
                           #list(list(className = 'dt-body-right', 
                          #           targets = 3)),
                           lengthMenu = list(c(25,50,-1),
                                             c(25,50,"Todos"))
                           )
                   ) |> 
  formatStyle(columns = c(5:39), `text-align`= 'center') |> 
  formatStyle(columns = 4, `text-align`= 'right') |> 
  formatStyle(columns = c(1:39), '9px') |> 
  formatRound(columns = c(5:15,17,30:31, 34,36:37,39), digits = 2, dec.mark = ",", mark = ".") |> 
  #formatRound(columns = c(4), digits = 0, mark = ".") |> 
  formatRound(columns = c(4, 16, 18, 19, 32, 33, 35, 38), digits = 0, mark = ".") |> 
  
  formatStyle(columns = c(5),
  background = styleColorBar(resum[,5], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |>
  formatStyle(columns = c(6),
  background = styleColorBar(resum[,6], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(7),
  background = styleColorBar(resum[,7], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(8),
  background = styleColorBar(resum[,8], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(9),
  background = styleColorBar(resum[,9], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(10),
  background = styleColorBar(resum[,10], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(11),
  background = styleColorBar(resum[,11], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(12),
  background = styleColorBar(resum[,12], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(13),
  background = styleColorBar(resum[,13], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |>
  formatStyle(columns = c(14),
  background = styleColorBar(resum[,14], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(15),
  background = styleColorBar(resum[,15], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  #formatStyle(columns = c(16),
  #background = styleColorBar(resum[,16], 'lightblue'),
  #backgroundSize = '98% 88%',
  #backgroundRepeat = 'no-repeat',
  #backgroundPosition = 'center') |> 
  formatStyle(columns = c(17),
  background = styleColorBar(resum[,17], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  #formatStyle(columns = c(18),
  #background = styleColorBar(resum[,18], 'lightblue'),
  #backgroundSize = '98% 88%',
  #backgroundRepeat = 'no-repeat',
  #backgroundPosition = 'center') |> 
  formatStyle(columns = c(19),
  background = styleColorBar(resum[,19], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(20),
  background = styleColorBar(resum[,20], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(21),
  background = styleColorBar(resum[,21], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(22),
  background = styleColorBar(resum[,22], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(23),
  background = styleColorBar(resum[,23], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(24),
  background = styleColorBar(resum[,24], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(25),
  background = styleColorBar(resum[,25], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(26),
  background = styleColorBar(resum[,26], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(27),
  background = styleColorBar(resum[,27], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(28),
  background = styleColorBar(resum[,28], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(29),
  background = styleColorBar(resum[,29], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(30),
  background = styleColorBar(resum[,30], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(31),
  background = styleColorBar(resum[,31], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  #formatStyle(columns = c(32),
  #background = styleColorBar(resum[,32], 'lightblue'),
  #backgroundSize = '98% 88%',
  #backgroundRepeat = 'no-repeat',
  #backgroundPosition = 'center') |> 
  #formatStyle(columns = c(33),
  #background = styleColorBar(resum[,33], 'lightblue'),
  #backgroundSize = '98% 88%',
  #backgroundRepeat = 'no-repeat',
  #backgroundPosition = 'center') |> 
  formatStyle(columns = c(34),
  background = styleColorBar(resum[,34], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(35),
  background = styleColorBar(resum[,35], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(36),
  background = styleColorBar(resum[,36], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  formatStyle(columns = c(37),
  background = styleColorBar(resum[,37], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center') |> 
  #formatStyle(columns = c(38),
  #background = styleColorBar(resum[,38], 'lightblue'),
  #backgroundSize = '98% 88%',
  #backgroundRepeat = 'no-repeat',
  #backgroundPosition = 'center') |> 
  formatStyle(columns = c(39),
  background = styleColorBar(resum[,39], 'lightblue'),
  backgroundSize = '98% 88%',
  backgroundRepeat = 'no-repeat',
  backgroundPosition = 'center')


#df <- tibble(
#  country = c("UK", "US"),
#  name = c("BBC", "CNN"),
#  link = c("https://www.bbc.com/news", "https://edition.cnn.com/"))
  
# using html
#df %>%
#    mutate(
#        link = map(link, ~ htmltools::a(href = .x, "website")),
#        link = map(link, ~ gt::html(as.character(.x)))) %>%
#    gt()





```

```{r include=FALSE}

fichas <- resum |> 
    #mutate(across(everything(), as.character)) |> 
    pivot_longer(c(5:39)) |> 
    mutate(ODS= str_sub(name,1,5)) |> 
    select(1,2,3,4,7,5,6) |> 
    mutate(ODS= str_remove(ODS, "\\."))

#write.csv(fichas,
#  "FichasMunicipales/fichas.csv", 
#  row.names = FALSE)


```


# Metodología {data-navmenu="Aspectos metodológicos"}


```{r eval=FALSE, fig.width= 13.3}
knitr::include_url("https://analysis.cat/cruzroja/ods/MetodologiaODS.html", 
                   height = '700px')
```


<div class="metodologia" style= "margin-left:10px; margin-right:20px;padding-bottom: 50px; text-align:justify;">
<h1 style= "color:#8e131d";>Apuntes metodológicos</h1>
<h3><b>Premisa</b></h3>
Este documento explica los principios y la metodología general para obtener los indicadores sobre ODS en la Comunitat Valenciana. Se explica el método de cálculo (sobre todo para aquellos indicadores en los que el método utilizado es más indirecto) y las fuentes de datos utilizadas. No se explica aquí el detalle de las diferentes operaciones de procesamiento y limpieza de los datos, que se han llevado a cabo en el entorno de programación de R. Para ello, si hubiera esta necesidad, recomendamos ponerse directamente con el equipo de Cruz Roja. Tampoco se detalla la aproximación epistemológica, sobre el porqué de priorizar unas dimensiones frente a otras, ya que entendemos que supera el alcance del trabajo de creación de la herramienta.

El producto se ha concebido no como informe cerrado sino como **una herramienta viva, en evolución continua** pensada como **soporte al análisis y la toma de decisiones** de los equipos técnicos y directivos de Cruz Roja y de actores que la quieran utilizar.

El objetivo de estas notas metodológicas es conseguir la **replicabilidad de los resultados** de la herramienta como estrategia para asegurar la **sostenibilidad** de la misma, independientemente del equipo que se encargue de su desarrollo.


<h3>Municipios reseñados e indicadores</h3>

Esta herramienta es un instrumento para analizar la totalidad de los **542 municipios valencianos**, sin excluir ningún municipio. Sin embargo este principio, que ha sido la base del encargo de Cruz Roja, hace que en diversos casos no se disponga del indicador para unos determinados municipios. Lo cual no invalida la herramienta, dado que el objetivo ha sido tener el máximo de indicadores para el máximo de municipios, sin embargo no podemos renunciar a un indicador importante aunque no se disponga del dato para la totalidad de los municipios. Esto ocurre sobre todo con indicadores que implican personas (salud, delincuencia, pobreza, etc.) para los que los agentes productores de datos introducen filtros para preservar la confidencialidad (*silencio estadístico*); esto se da en el caso de municipios pequeños, cuando el valor del dato a facilitar baja de un cierto límite de habitantes. De todos modos, cabe destacar que hemos procurado priorizar indicadores con mayor cobertura y hemos renunciado en ocasiones a indicadores disponibles solo para unos pocos municipios (por ejemplo, los indicadores para municipios de más de 50.000 habitantes o capitales de provincias).

<h3>Selección y estructura de los indicadores</h3>
El proceso de identificación, selección y construcción de los indicadores utilizados en el análisis tiene como punto de partida las necesidades de información de Cruz Roja, descritas en un documento inicial muy amplio y detallado. A partir de él, se ha realizado un rastreo de las fuentes de datos disponibles, en base al que se han podido identificar los indicadores viables, los que se podían adoptar modificando algún elemento y los que se tenían que descartar. En algún caso se ha propuesto un nuevo indicador.

Todos los indicadores se han relacionado con un ODS concreto. Los **modelos** que se han seguido, de manera más sistemática, para **construir e identificar indicadores y localizar los datos** han sido básicamente:

- La página web [Indicadores de la Agenda 2030 para el Desarrollo Sostenible](https://www.ine.es/dyngs/ODS/es/index.htm){target="_blank"} del Instituto Nacional de Estadística.
- El Informe [Sisto, R., Benayas, J., 2021. Los municipios de la Comunidad de Madrid y la Agenda 2030. Diagnóstico sobre su grado de aplicación. INAECU y REDS / SDSN-SPAIN](https://reds-sdsn.es/ods-madrid/){target="_blank"} de la Red Española de Desarrollo Sostenible (REDS).
- El informe [REDS, 2020. Los ODS en 100 ciudades españolas (2ª edición)](https://reds-sdsn.es/informe-ods-ciudades-2020/){target="_blank"}.

Hay otros informes y documentos que se han utilizado, a lo largo del proceso: ver para ello los puntos específicos de este documento y también la página de *Bibliografia*.

<h3>Fuentes de datos</h3>
En este documento y en el *Catálogo de datos* se detallan las fuentes utilizadas para cada indicador. Se han utilizado los datos más recientes disponibles pertenecientes a **fuentes oficiales consolidadas y publicadas**, independientemente del formato (base de datos descargable, página web, buscador web). Hay dos excepciones: en dos casos los datos no se han obtenido de la red, sino de un envío directo por email, y corresponden a (i) los datos sobre Educación para la Ciudadanía Global en los centros educativos valencianos, facilitados por la **Dirección General de Inclusión y Cooperación al Desarrollo** de la Generalitat Valenciana; y (ii) una parte de los datos sobre aportación presupuestaria al 0.7% de los municipios valencianos aportada por el **Fons Valencià per la Solidaritat**.

La **calidad, fiabilidad y disponibilidad futura** de las fuentes de datos es importante para asegurar la **viabilidad** de la herramienta en el medio-largo plazo.

<h3>Estructura del instrumento</h3>

- **Mapas municipales**: son unos mapas municipales interactivos coloreados con diversas intensidades según el valor del indicador. La interactividad permite leer los datos de cada municipio.
- **Panel de índices integrados por ODS** en forma de tabla degradada, descargable en formato Excel.
- **Listado de municipios**: se presentan todos los municipios en una tabla interactiva (permite ordenar y seleccionar variables) que contiene todos los indicadores, descargable en Excel.
- **Fichas municipales**: cada municipio tiene un resumen individual, descargable en Excel.

La descargabilidad de los documentos es importante para facilitar las tareas de análisis de los equipos de trabajo.

<h3><b>Mapas de municipios y provincias</b></h3>

El mapa por municipios se genera a partir de un archivo *shapefile* disponible en el portal de internet de datos abiertos [datos.gob.es](https://datos.gob.es){target="_blank"} del Ministerio para la Transfomación Digital y par la Función Pública:  [link directo](https://datos.gob.es/es/catalogo/a10002983-capa-de-municipios-de-la-comunidad-valenciana){target="_blank"}.

El mapa de provincias se genera de un rchivo *shapefile* disponible en el portal [opendatasoft.com](https://www.opendatasoft.com/en/){target="_blank"}:  [link directo](https://public.opendatasoft.com/explore/dataset/provincias-espanolas/table/?sort=provincia){target="_blank"}

<h3><b>Datos de población</b></h3>
**Población municipios - Años 2019 2020, 2021, 2022, 2023, 2024** 
Para los cálculos de los índices, en muchos casos, ha sido necesario fusionar los datos obtenidos con tablas de población por municipios, de años diferentes (en función del año de referencia de los datos obtenidos).
Par ello, hemos obtenido los datos de población del [Banco de Datos Terrritorial del Institut Valencià de Estadística (IVE)](https://bdt.gva.es/bdt/){target="_blank"}, que además, junto con el **Instituto Nacional de Estadística (INE)**, ha sido una importante fuente de datos para nuestro trabajo.
Específicamente la tabla original del padrón, años 1996-2023, que utilizamos se descarga en [este enlace](https://bdt.gva.es/bdt/res_optimo_static.php?cons=C1V4873&idioma=cas&form=xls){target="_blank"}. Su fuente es el padrón continuo. Tratándose de una tabla muy grande, que contiene datos de muchos años y por sexo han sido necesarias varias operaciones de limpieza y selección, que quedan reflejadas en el fichero Rmd correspondiente.

Para algunos indicadores (ver más abajo) también ha sido necesario disponer del [Padrón continuo-Año en año](https://www.ine.es/dynt3/inebase/index.htm?padre=6225&capsel=6225){target="_blank"} del INE. A partir del año 2023, los datos de población por edad, año a año se obtienen del [Censo Anual de población](https://www.ine.es/dynt3/inebase/index.htm?padre=10607&capsel=10607){target="_blank"}.

<h3>ODS 1</h3>
- **Tasa de Riesgo de Pobreza**: Población con **ingresos por unidad de consumo por debajo 60% de la mediana nacional**. Es la definición aceptada para población en riesgo de pobreza ([Ver INE](https://www.ine.es/ss/Satellite?L=es_ES&c=INESeccion_C&cid=1259925455948&p=%2F&pagename=ProductosYServicios%2FPYSLayout&param1=PYSDetalle&param3=1259924822888#:~:text=Umbral%20de%20riesgo%20de%20pobreza,la%20renta%20entre%20la%20poblaci%C3%B3n.){target="_blank"}).  Los dato se obtienen directamente del [Atlas de distribución de renta de los hogares del INE](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}, se bajan separadamente por provincias y se integran posteriormente.
- **Tasa de Pobreza Severa**: Población con **ingresos por unidad de consumo por debajo 40% de la mediana nacional**. Es la definición aceptada para población en pobreza severa: Ver por ejemplo [El mapa de la pobreza severa en España, EAPN España, 2022](https://www.eapn.es/ARCHIVO/documentos/noticias/1671549839_2022-abandonadas.-la-pobreza-severa-en-espaa.pdf){target="_blank"}, pág. 5. Los dato se obtienen directamente del [Atlas de distribución de renta de los hogares del INE](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}, se bajan separadamente por provincias y se integran posteriormente.
- **Tasa municipal de Pobreza Infantil Severa**: **Población menor de 18 años** con ingresos por unidad de consumo por **debajo del 40% de la mediana nacional (%)**. Ver también el [Alto Comisionado contra la Pobreza Infantil](https://www.comisionadopobrezainfantil.gob.es/es){target="_blank"}. Los dato se obtienen directamente del [Atlas de distribución de renta de los hogares del INE](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}, se bajan separadamente por provincias las tablas de **datos por tramos de edad y sexo** y se integran posteriormente.
- **Tasa de gasto por hab. en Servicios sociales y promoción social**: En la actualización de 2025, se trata de la tasa media que se obtiene de la liquidación de los presupuestos de 2021, 2022 i 2023, dividiendo el importe de de la **política de gasto número 23** del presupuesto según la clasificación por programas ([ver orden Orden EHA/3565/2008, de 3 de diciembre](https://www.boe.es/buscar/act.php?id=BOE-A-2008-19916){target="_blank"}) por el total de los habitantes del municipio en el año 2022 (el del medio): 
$$\frac{Valor Medio 23_{21|22|23}}{Habitantes}$$
En esta edición de 2025 trabajamos con los valores medios para disminuir el efecto que pueden producir eventos o inversiones puntuales en el presupuesto municipal, sobre todo en municipios pequeños.

En nuestro caso, hemos obtenido los datos contables de las entidades locales del **Ministerio de Hacienda y Función Pública**, específicamente del portal [CONPREL: CONSULTA PRESUPUESTOS Y LIQUIDACIONES DE EELL](https://serviciostelematicosext.hacienda.gob.es/SGFAL/CONPREL){target="_blank"} (hay que marcar el año y si se quieren presupuestos o liquidaciones. El portal facilita un base de datos en *Access* de la que hemos extraído los datos en formato texto para su posterior procesamiento.

<h3>ODS 2</h3>
**Nivel estimado de Privación Material Severa AROPE**: el Índice de Privación Material Severa sería un indicador muy potente que se recoge en la [Encuesta de Condiciones de Vida - ECV](https://www.ine.es/dyngs/INEbase/es/operacion.htm?c=Estadistica_C&cid=1254736176807&idp=1254735976608){target="_blank"} que realiza el INE anualmente. Sin embargo, no se disponen de datos directos de ámbito municipal para obtener dicho indicador.

A pesar de no ser directamente medible, hemos decidido incluir una estimación de tipo categórico, a partir de la constatación de la existencia de un nivel alto de correlación entre **Privación Material Severa(ECV)** y **Pobreza Severa (INE)** que acabamos de ver entre los indicadores del ODS 1. En [este documento](https://gaiacooperacion.net/proves/CarenciaSevera.html){target="_blank"} describimos la relación linear (coef. de Pearson) existente entre ambas variable a nivel de valores comarcales (la Privación Material Severa se obtiene del [Banco de Datos Territorial del IVE - Datos subregionales](https://pegv.gva.es/es/indicadores-de-pobreza-y-condiciones-de-vida-a-nivel-subregional){target="_blank"}).

Dada la correlación existente entre ambos indicadores, podemos plantear que el valor de la diferencia entre el valor municipal y el valor comarcal de un indicador se mantenga proporcional respecto a la misma diferencia en el otro indicador.
Esto es:

Valor Municipal Pobreza Severa $=ps_{i}$ 
Media Comarcal de la Pobreza Severa $=mps_{com}$ 
Valor municipal de Privación Material Severa $=pms_{i}$
Valor Comarcal de la Privación Material Severa $=mpms_{com}$

$$\frac{(ps_{i}-mps_{com})}{mps_{com}}=\frac{(pms_{i}-mpms_{com})}{mpms_{com}}$$

Por lo tanto, aplicando dicha proporcionalidad, estimamos que el valor de la Privación Material Severa $pms_{i}$ a nivel municipal será:

$$pms_i= 1+\frac{ps_{i}-mps_{com}}{mps_{com}}$$

Puesto que este cálculo es una estimación basada en la correlación existente entre dos variables que en cualquier caso debería ser corroborada por *tests* más concluyentes, para ese indicador hemos establecido un índice estimado de cuatro niveles, cuatro segmentos iguales entre el valor mínimo y el valor máximo: *Bajo, Medio, Alto, Muy alto*. A efectos de cálculo de índices los valores categóricos se convierten en enteros: 1, 2, 3, 4.
Entendemos que **no es lo ideal** pero es una manera de **aproximarnos** a un indicador que, de otro modo no sería disponible a nivel municipal.


<h3>ODS 3</h3>
- **Tasa de defunciones prematuras**: este indicador mide la proporción de defunciones en edades que podemos considerar tempranas. Hemos seguido el modelo de [REDS, 2020. Los ODS en 100 ciudades españolas (2ª edición)](https://reds-sdsn.es/informe-ods-ciudades-2020/){target="_blank"}.
En base a este modelo, se consideran prematuras todas las defunciones antes de la edad de 65 años. 
- **Edad media de defunción**: sustituye la Esperanza de vida, de cálculo complejo, para comunidades pequeñas.
- **Tasa de mortalidad por suicidio**: ver puntos anteriores.
- **Tasa de mortalidad por infarto del miocardio**: ver puntos anteriores

Para la obtención de estos índices, hemos utilizado [microdatos de mortalidad y sus causas](https://www.ine.es/dyngs/INEbase/es/operacion.htm?c=Estadistica_C&cid=1254736176780&menu=resultados&idp=1254735573175#_tabs-1254736195294){target="_blank"} facilitados por el **Instituto Nacional de Estadística** tras nuestra solicitud, disponibles para municipios de más de 10.000 habitantes. Además, para obtener la **Tasa de defunciones Prematuras** hemos necesitados **Censo Anual de Población por edad año a año (ver arriba)**.

<h3>ODS 4</h3>
- **Tasa de completamiento segunda etapa de Educación Secundaria y post secundaria no Superior (%)**: Es la tasa (%) de personas que logran este nivel educativo (segunda etapa de Secundaria y eventuales grados medios o superiores). Importante: **excluye tanto los niveles inferiores como los superiores**. Se calcula sobre la población total del municipio (2021):
Población que ha completado el nivel: $Pob_{diploma}$; Población total: $Pob_{tot}$;
$$Indicador=\frac{Pob_{diploma}}{Pob_{tot}}\times100$$
Como se ve, no se selecciona ninguna banda de edad sobre la que realizar cálculo. Esto se hace para poder tener el dato para el máximo de municipios y no perder dato por *silencio estadístico*. En esta edición, los datos se obtienen del [Censo anual de población 2021-2022](https://www.ine.es/dynt3/inebase/es/index.htm?padre=10608&capsel=10612){target="_blank"}. Hay que realizar una serie de selecciones sucesivas para llegar a la tabla que se descarga.
- **Gasto municipal en educación / hab.**: En la edición de 2025, es la tasa que se obtiene de las liquidaciones de los presupuestos de 2021, 2022 y 2023, de la política 32. Trabajamos con importes medios, introduciendo tres años contables y realizando el cálculo del promedio en este caso, para disminuir el peso de importes "*outliers*", seguramente debidos a inversiones puntuales. Para el resto se opera  dividiendo el importe medio calculado (2021, 2022, 2023) de la **política de gasto 32 - Educación** del presupuesto según la clasificación por programas ([ver orden Orden EHA/3565/2008, de 3 de diciembre](https://www.boe.es/buscar/act.php?id=BOE-A-2008-19916){target="_blank"}) por el total de los habitantes del municipio: $$\frac{Valor Medio 32_{21|22|23}}{Habitantes}$$
También en este caso, hemos obtenido los datos contables de las entidades locales del **Ministerio de Hacienda y Función Pública**, específicamente del portal [CONPREL: CONSULTA PRESUPUESTOS Y LIQUIDACIONES DE EELL](https://serviciostelematicosext.hacienda.gob.es/SGFAL/CONPREL){target="_blank"} (hay que marcar el año y si se quieren presupuestos o liquidaciones. El portal facilita un base de datos en *Access* de la que hemos extraído los datos en formato texto para su posterior procesamiento.
- **Educación para el Desarrollo en centros educativos del Municipio**: hemos procesado datos no publicados, facilitados por la **Dirección General de Cooperación y Solidaridad** de la Generalitat Valenciana. Se trata de fichas en formato *pdf* que resumen las **actividades de EpCG** llevadas a cabo, en el marco de la convocatoria 2020, **en los centros educativos valencianos**, por las ONGD valencianas. Del procesamiento de esas fichas, se pueden obtener los **municipios donde se encuentran los centros** en los que se han ejecutado dichas actividades. Cabe destacar que además de esas fichas, la Dirección General nos entregó fichas de actividades de sensibilización que sin embargo no se pudieron procesar. El dato que se obtiene es un dato categórico de cobertura: "Sí" - "No" (realizadas actividades o no en el municipio), no de intensidad. En el cálculo de los índice se convierte en entero: 1, 0, respectivamente.

<h3>ODS 5</h3>
- **Delitos contra la libertad sexual por 10.000 hab.**: el dato se obtiene del [Balance trimestral de la criminalidad, 4º trimestre 2024](https://estadisticasdecriminalidad.ses.mir.es/publico/portalestadistico/datos.html?type=pcaxis&path=/DatosBalanceAnt/20244/&file=pcaxis){target="_blank"}, del Ministerio de Interior. Los delitos están clasificados por categorías y cuantificados, **para municipios de más de 20.000 habitantes*. La categoría es *5. Delitos contra la libertad sexual* que tiene 2 subcategorías. El dato facilitado es por número de casos. Nuestro trabajo ha sido poner en relación el número de casos con la población del municipio.
$$Indicador=\frac{Casos}{hab.}\times10000$$

- **Participación en la Red Valenciana de Igualdad**: La obtención de las Entidades Locales participantes en la Rde Valenciana de Igualdad (RVI) promovida por la [Dirección General de Igualdad y del Instituto de las Mujeres](https://inclusio.gva.es/es/web/igualtat-i-institut-de-les-dones/xarxa-valenciana-d-igualtat){target="_blank"} se ha realizado en 2 fases: primero se han recopilado (*scraping*) las instituciones listadas en el índice de la página; en segundo lugar, como la mayoría de los ayuntamientos participan no directamente, sino a través de alguna mancomunidad, hemos tenido que recuperar los ayuntamientos miembros de las mancomunidades listadas, recopilando los datos de Mancomunidades del [BUSCADOR DE ENTIDADES LOCALES](https://www.gva.es/es/inicio/atencion_ciudadano/buscadores/administraciones_locales){target="_blank"} y posteriormente fusionarlos con los del Instituto de las Mujeres. Hemos obtenido así una tabla de ayuntamientos miembros de la Red Valenciana de Igualdad. El indicador es categórico, "Sí" - "No", que se convierten en 1,0 respectivamente, en el cálculo de los índices.

<h3>ODS 6</h3>
**Vulnerabilidad municipal por contaminación de las aguas por nitratos**: Hemos recopilado los datos de los municipios declarados vulnerables por la presencia de nitratos en las aguas superficiales y/o subterráneas, directamente de los [tres decretos](https://mediambient.gva.es/es/web/agua/zones-vulnerables){target="_blank"} publicados en por la GVA (Orden 10/2018, Decreto 86/2018, Decreto 81/2022). Este indicador: la presencia de los dos factores a la vez se cuantifica con un 2, la presencia de uno de los dos, con un 1, la ausencia de ambos, con 0.

<h3>ODS 7</h3>
- **Tasa de viviendas con aislamiento deficiente**: Es un indicador que está incluido únicamente en los mapas, ya que forma parte del indicador *Nivel estimado de riesgo de vulnerabilidad energética*. De todos modos, hemos aumentado su solidez como indicador. Su mejora de solidez se ha obtenido utilizando no solamente los datos de los certificados energéticos del últimos año dispnible, sino de **todos los certificados que tengan vigencia en 2025**. Esto conlleva analizar todos (alrededor de unos 900.000) los certificados emitidos entre 2015 y 2024 (los del año 2025 no están disponibles). Los datos se pueden encontrar en la [página web correspondiente del IVACE](https://gceedadesobertes.aven.es/dadesobertes/Home){target="_blank"}. El tratamiento consiste en contar los certificados energeticos vigentes y establecer, para cada municipio, el **% de certificados con valoración "G"**, la más baja de todas. 
- **Nivel estimado de riesgo de vulnerabilidad energética**: Es un indicador categórico, calculado indirectamente, que hemos decidido utilizar, delante de la imposibilidad de obtener datos directos sobre pobreza energética, *Gasto desproporcionado, Indicador de gasto energético insuficiente, Indicador de retraso en pagos, Indicador de retraso en pagos, Indicador de temperatura inadecuada* (todos indicadores que están el [Informe de Indicadores de Pobreza Energética en España 2022](https://www.comillas.edu/noticias/la-pobreza-energetica-siguio-creciendo-en-espana-en-2022/#:~:text=El%20Informe%20de%20Indicadores%20de,temperatura%20adecuada%20en%20sus%20hogares.){target="_blank"}), hemos optado por proceder de una manera sencilla generando un indicador que combinara el elemento de vulnerabilidad socioeconómica (el indicador de Pobreza Severa) con un elemento de debilidad estructural desde la perspectiva de las infraestructuras. Para ello, hemos testado diferentes alternativas [en un documento aparte](https://gaiacooperacion.net/proves/PobrezaEnergMetod.html), y hemos decidido optar por la siguiente alternativa: crear un índice compuesto entre dos variables:

    - Tasa de Pobreza Severa (ver ODS 1)
    - Tasa de viviendas con aislamiento deficiente (ver indicador anterior)

Esta opción de crear un **indice compuesto** combinando un un indicador de pobreza con un elemento de debilidad energética de estructuras, se ha utilizado recientemente también en un estudio sobre pobreza energética en la ciudad de Valencia ([Sujar Cost A., ANALISIS GEOESPACIAL DE LA DISTRIBUCIÓN DE LA POBREZA ENERGÉTICA DEL SECTOR RESIDENCIAL DE LA COMUNIDAD VALENCIANA, 2022](https://riunet.upv.es/handle/10251/185142?show=full){target="_blank"}). Nosotros vamos a utilizar un enfoque similar, **identificando unas categorías determinadas para los diferentes niveles de los dos indicadores implicados**.
Una vez obtenidas las dos tasas, normalizamos creando dos índices: **Índex de pobreza severa** e **Índex de ineficiencia energética**, aplicando la fórmula:
$$Indice_{i}=\frac{Valor_{i}-Valor_{min}}{Valor_{max}-Valor_{min}}$$
Tratándose de un indicador experimental, en lugar de integrar ambos índices por media aritmética hemos optado por generar 4 categorías: *Bajo, Medio-bajo, Medio-alto, Alto*, para los cuatro diferentes niveles numéricos de los indicies: 0-0.25, 0.25-0.50, 0.50-0.75, 0.75-1. De la combinación dichas cuatro categorías o niveles en los dos índices se genera la tabla siguiente:



```{r}
library(flextable)
library(dplyr)

data.frame(AltoNivelG= c("Muy alto", "Muy alto", "Alto", "Medio"),
           M.AltoNivelG= c("Muy alto","Alto","Medio","Medio"),
           M.BajoNivelG= c("Alto","Medio","Medio","Bajo"),
           BajoNivelG= c("Medio", "Medio", "Bajo", "Bajo"),
           row.names = c("Pobreza severa - Nivel alto",
                         "Pobreza severa - Nivel medio-alto",
                         "Pobreza severa - Nivel medio-bajo",
                         "Pobreza severa - Nivel bajo")) |> 
    add_rownames() |> 
    flextable() |> 
    width(width = 2) |> 
    set_header_labels(rowname= '', AltoNivelG= 'Alto índice de ineficiencia enrgética',M.AltoNivelG= "Medio-alto índice de ineficiencia energética",M.BajoNivelG= "Medio-bajo índice de ineficiencia energética", BajoNivelG= 'Bajo índice de ineficiencia enrgética') |> 
    set_caption('Niveles de riesgo de Vulnerabilidad Energética en función de los indices de Pobreza Severa y de Ineficiencia energética')


```
Estos valores aparecen en el la representación cartográfica y en la ficha municipal, mientras que en el mapa de calor y en el listado general se pasan al formato de número entero (1-4).

<h3>ODS 8</h3>

- **Tasa de demandantes de empleo**: Esta tasa se calcula en % sobre el total de la población entre 16 y 64 años, aprovechando datos de población del [Censo anual de poblacion 2021-2024. Resultados por municipios (Población por sexo y edad año a año)](https://www.ine.es/dynt3/inebase/index.htm?padre=10607&capsel=10607){target="_blank"} y datos de [demandantes de empleo a diciembre de 2024 del portal Labora](https://labora.gva.es/va/estadisticassispehtml){target="_blank"}.
- **Tasa de demandantes de empleo menores de 25 años**: Se calcula en % sobre el total de la población entre 16 y 24 años de edad, utilizando el [Censo anual de poblacion 2021-2024. Resultados por municipios (Población por sexo y edad año a año))](https://www.ine.es/dynt3/inebase/index.htm?padre=10607&capsel=10607){target="_blank"} y datos de [demandantes de empleo a diciembre de 2024 del portal Labora](https://labora.gva.es/va/estadisticassispehtml){target="_blank"}, extrayendo la tabla por edad.

<h3>ODS 10</h3>

- **Tasa de personas con ingresos inferiores al 50% de la mediana**: este dato es facilitado por el [INE](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}. Es una magnitud que está entre la Pobreza Severa (ingresos inferiores al 40% de la mediana) y el Riesgo de Pobreza (60%), que hemos visto en el ODS 1. 
- **Índice Gini**: este dato es un indicador económico que mide la uniformidad/disformidad de la distribución de un conjunto de datos, en este caso las rentas. Esto es, cuanto más cercano a 0 más uniforme es la distribución de las rentas, cuanto más cercano a 100 más disforme y desigual es dicha distribución. La fuente de datos es la misma que el indicador anterior.
- **Tasa de dependencia**: la tasa de dependencia es un indicador demográfico que mide en una población la proporción de personas en edad que se supone "económicamente inactiva" (menores de 16 años, mayores de 64) con relación al total de personas en edad "económicamente activa" (entre 16 y 64 años). Los datos se obtienen del [Censo anual de poblacion 2021-2024. Resultados por municipios (Población por sexo y edad año a año)](https://www.ine.es/dynt3/inebase/index.htm?padre=10607&capsel=10607){target="_blank"}, que ya hemos visto para otros indicadores.

<h3>ODS 11</h3>

- **Vulnerabilidad urbana**: Se trata de un indicador sobre el que parece no existir aún una definición unívoca. En nuestro caso, para su definición, nos hemos basado en [modelos propuestos por otros autores](https://reds-sdsn.es/ods-madrid/){target="_blank"} que nos han parecido interesantes. Este indicador mide la **proporción de habitantes de un municipio que vive en secciones vulnerables**. Nuestra definición: *Una sección es vulnerable cuando la Tasa de Riesgo de pobreza (ODS1) supera la media de la Provincia a la que pertenece el municipio*. NOTAR BIEN: Es una adaptación de la definición de [Sisto, R., Quintanilla, A., García, J., 2020](https://reds-sdsn.es/informe-ods-ciudades-2020/){target="_blank"}. **Dichos autores utilizan la media nacional como referencia. Nosotros optamos por la media provincial, por adaptarse mejor a la realidad local. Sin embargo, esta no es una cuestión cerrada aún**. Los datos (2022) de Pobreza por secciones se descargan de [INE - Atlas de distribución de renta de los hogares - Resultados por municipios, distritos y secciones censales](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}. Hay que elegir la provincia y la opción "Secciones" > "Porcentaje de población con ingresos por unidad de consumo por debajo/encima de determinados umbrales relativos por sexo" y, una vez dentro, elegir: Unidades territoriales: Secciones. Para saber cuántos habitantes viven en secciones censales vulnerables hemos de obtener los datos del INE de [Habitantes por secciones censales (2022) - Censo Anual de Población 2021-2024](https://www.ine.es/dynt3/inebase/index.htm?padre=11555&capsel=11100){target="_blank"} y fusionarlos con los datos de vulnerabilidad.
- **Nivel por contaminación de PM10**: Número de días del año con concentración de PM10 superior a 40 μg/m3. Este límite se ha marcado a partir de la [Resolución de 2 de septiembre de 2020, de la Dirección General de Calidad y Evaluación Ambiental](https://www.boe.es/buscar/doc.php?id=BOE-A-2020-10426){target="_blank"}, en la que se determinan los límites de contaminación por diversos agentes. Hemos elegido el valor de 40 μg/m3 como límite para contar los días y construir el indicador porque la Resolución define diferentes niveles para este indicador y, a partir del valor 40 μg/m3, el nivel de contaminación se define *Regular*, recomendando lo siguiente: "La calidad del aire probablemente no afecte a la población general pero **puede presentar un riesgo moderado para los grupos de riesgo**." Existen otros límites que se podrían estimar. Cabe destacar que la OMS ha manifestado recientemente que en futuro recomendará bajar este límite hasta los 20 μg/m3. Para elaborar el indicador tenemos que obtener los datos de la página [*Datos oficiales Calidad del Aire 2023* del MITECO](https://www.miteco.gob.es/es/calidad-y-evaluacion-ambiental/temas/atmosfera-y-calidad-del-aire/evaluacion-y-datos-de-calidad-del-aire/datos/datos-oficiales-2023.html){target="_blank"}, eligiendo "*Dados diarios 2023*". También es importante descargar el fichero de metadatos disponible en la misma página.
- **Índice de despoblación (2023)**: para no repetir un mero mapa de densidad de población, hemos querido construir un indicador que pusiera el foco en los municipios que podemos considerar despoblados a partir de **un límite determinado**, creando un índice con todos los municipios con un valor de densidad igual o inferior a este límite, poniendo como valor 0 dicho valor-límite de densidad y 1 la máxima despoblación (esto es, la densidad mínima). Hemos establecido como límite a partir del que podemos considerar un municipio como *despoblado*, el valor de 12,5 habitantes/km2. La referencia para definir este límite es el [DIAGNÓSTICO ESTRATEGIA NACIONAL FRENTE AL RETO DEMOGRÁFICO. EJE DESPOBLACIÓN](https://www.miteco.gob.es/content/dam/miteco/es/reto-demografico/temas/analisis-cartografia/diagnostico_eje_despoblacion_tcm30-517769.pdf){target="_blank"} del Comisionado del Gobierno frente al Reto Demográfico que, en su página 4 incluye, entre los criterios para definir poblaciones en riesgo de despoblación: **Densidad de población menor de 12,5 habitantes por km2**. Los [datos de densidad municipal (2024)](https://bdt.gva.es/bdt/res_optimo_static.php?cons=C0V6449&idioma=cas&form=xlsx){target="_blank"} para construir el indicador se han obtenido del *Banco de Datos Territorial de la GVA*.

<h3>ODS 12</h3>

- **Recogida selectiva de envases ligeros**: Se utiliza el dato en kg/hab./año tal y como lo facilita **ECOEMBES** en su [buscador](https://www.ecoembes.com/es/el-proceso-de-reciclaje/datos-de-reciclaje-de-envases-domestico-en-espana/recogida-selectiva-de-envases-domesticos/barometro){target="_blank"}. Hemos recopilado los datos del buscador en una base de datos.
- **Recogida selectiva de papel y cartón**: Se utiliza el dato en kg/hab./año tal y como lo facilita **ECOEMBES** en su [buscador](https://www.ecoembes.com/es/el-proceso-de-reciclaje/datos-de-reciclaje-de-envases-domestico-en-espana/recogida-selectiva-de-envases-domesticos/barometro){target="_blank"}. Hemos recopilado los datos del buscador en una base de datos.
- **Recogida selectiva de vidrio**: El dato se presenta en kg/hab./año, procesando las tres bases de datos provinciales que se descargan de la [página web de **ECOVIDRIO**](https://www.ecovidrio.es/reciclaje/datos-reciclaje){target="_blank"} (hay que seleccionar el año, 2022, la comunidad autónoma y las tres provincias valencianas).
- **Ecoparques en el municipio**: Se trata de un indicador categórico ("Sí", "No"), que se convierte en entero (1, 0) para el cálculo de los índices los índices. Define la presencia o no de ecoparques en el territorio municipal, independientemente de su número. El dato se ha obtenido recopilando la información del [Buscador de productores y gestores de residuos](https://residuos.gva.es/RES_BUSCAWEB/buscador_residuos_avanzado.aspx?idioma=C){target="_blank"} (Categoría "Ecoparques").

<h3>ODS 13</h3>
- **Participación en compromisos internacionales por el clima**: El [*Global Covenant of Mayors for Climate and Energy*](https://www.globalcovenantofmayors.org/){target="_blank"} (Pacto Mundial de Alcaldes por el Clima y la Energía - GCoM) es una iniciativa internacional para la acción climática a nivel de ciudad y municipio. El indicador es en este caso categórico ("Sí", "No", participación en el Pacto) y se convierte en entero (1, 0) para el cálculo de los índices. Los datos se obtienen de la [Base de datos de proyectos y firmantes de la UE - 2023](https://jeodpp.jrc.ec.europa.eu/ftp/public/JRC-OpenData/GCOM-MyCovenant/2023_Fourth_release/df1_Signatories_4th%20Release%20-%20March%202023.xlsx){target="_blank"}, procesando la tercera hoja de cálculo.

<h3>ODS 15</h3>

- **Tasa de ocupación de bosques**: Se trata de la tasa en % de la superficie calculada de bosque de especie maderable de lento crecimiento frente a la superficie total del municipio. Los datos de superficie de bosque y de superficie rústica municipal se obtienen de del [Catastro Inmobiliario Rústico](https://www.catastro.hacienda.gob.es/esp/estadistica_10.asp){target="_blank"}: primero hay que bajar las bases de datos (por provincias) de la **superficie municipal rústica** y después bajar la base de datos de % de ocupación por *Especies maderables de crecimiento lento* que suele ser la superficie de bosque clásico (no pastos o prados, no cultivos de maderables rápidas). Estos datos se tienen que combinar con la [base de datos de **superficies totales** de los municipios](https://bdt.gva.es/bdt/){target="_blank"} disponible en el **Banco de datos Territorial de la GVA** (seleccionar *Territori>Características físiques>Densitat de població*).
- **Espacios naturales protegidos**: es un indicador que cuantifica el número de espacios que cuentan con algún tipo de protección ambiental al interior del municipio. Los datos se obtienen del [Banco de Datos Territorial de la GVA](https://bdt.gva.es/bdt/){target="_blank"} (Medi Ambient > Estadístic d'Espais naturals protegits > Espais segons tipus).

<h3>ODS 16</h3>

- **Tasa de criminalidad general**: es la tasa de los delitos totales registrados, excluyendo los de ciberdelincuencia. La tasa se presenta así:
$$Indicador=\frac{Casos}{hab.}\times10000$$
Los datos se obtienen del [Balance trimestral de la criminalidad, 4º trimestre 2024](https://estadisticasdecriminalidad.ses.mir.es/publico/portalestadistico/datos.html?type=pcaxis&path=/DatosBalanceAnt/20244/&file=pcaxis){target="_blank"}, del Ministerio de Interior. Los delitos están clasificados por categorías y cuantificados, **para municipios de más de 20.000 habitantes**.
- **Tasa de homicidios e intentos de homicidios**: es la tasa de la partida *1. Homicidios dolosos y asesinatos consumados* y *2. Homicidios dolosos y asesinatos en grado tentativa*. La tasa se presenta así:
$$Indicador=\frac{Casos}{hab.}\times10000$$
Los datos se obtienen del [Balance trimestral de la criminalidad, 4º trimestre 2024](https://estadisticasdecriminalidad.ses.mir.es/publico/portalestadistico/datos.html?type=pcaxis&path=/DatosBalanceAnt/20244/&file=pcaxis){target="_blank"}, del Ministerio de Interior. Los delitos están clasificados por categorías y cuantificados, **para municipios de más de 20.000 habitantes**.

<h3>ODS 17</h3>

- **Miembros de la Red de Ciudades Educadoras**: Es un indicador categórico de la participación ("Sí", "No") a la **Asociación Internacional de Ciudades Educadoras (AICE)**. Se convierte en entero para calcular los índices integrados. El dato se obtiene recopilando la [página web de la asociación](https://www.edcities.org/listado-de-las-ciudades-asociadas/){target="_blank"}.
- **Tasa de presupuesto dedicado a Cooperación Internacional**: Es un indicador que se expresa como porcentaje del presupuesto que el ayuntamiento dedica a Cooperación Internacional **frente al Presupuesto de Ingresos Propios del ayuntamiento**.
Este último aspecto es particularmente delicado y cabe formular algunas consideraciones: **puede haber diferencias y ambigüedades en lo que se refiere al concepto de Ingresos Propios**, por ello es muy importante **definir previamente** como se definen y mantener constante el mismo criterio. Para ello sería bueno disponer un criterio específico para las entidades locales de la CVA. Sin embargo, de momento no lo hemos encontrado. El Fons Valencià per la Solidaritat ha publicado el estudio "*La cooperació al desenvolupament en l’esfera local des del Fons Valencià per la Solidaritat i les entitats sòcies*", sin embargo no toca este aspecto. Para ello, nos basaremos pues en el criterio recomendado por Joaquim Solé (Universitat de Barcelona) en el documento [CRITERIS D’APLICACIÓ DEL 0’7% DELS INGRESSOS PROPIS MUNICIPALS A LA COOPERACIÓ AL DESENVOLUPAMENT. JUSTIFICACIÓ TÈCNICA](https://www.fonscatala.org/upload/archivos/20170214_0709JUSTIFICACIO_07_INGRESSOS_MUNICIPALS.pdf){target="_blank"}, publicado por Fons Català de Cooperació al Desnevolupament. Este documento considera lo siguiente (pág. 10): *En resumen, a efectos de la aportación del 0,7%, deben considerarse ingresos propios todos los impuestos directos (cap. 1), los impuestos indirectos (cap. 2), las tasas, los precios públicos y las contribuciones especiales y las cuotas de urbanización (cap. 3, excepto los reintegros) y los ingresos patrimoniales, incluidos los beneficios de empresas y cañones de concesiones (cap. 5) del presupuesto liquidado y consolidado de ingresos. Quedan excluidos del cálculo del 0,7% los reintegros y otros ingresos (art. 38) y las tasas o precios por transporte urbano (conc. 345) y por abastecimiento de agua a domicilio (conc. 300)*.
Esto es: Iingresos Propios: $IP$
$$IP=Cap1 + Cap2+ Cap 3 + Cap5 - Art38-Conc300-Conc345$$
Importante: estas cantidades deben considerarse a partir de las **liquidaciones consolidadas de ingresos**, **importes reconocidos**.
Definido el criterio, cabe destacar que los importes destinados a Cooperación se han obtenido de una base de dado facilitada directamente por el **Fons Valencià per la Solidaritat** y por recopilación de datos de la [Federación Española de Municipios y Provincias - FEMP](http://cooperacion.femp.es/){target="_blank"}. En cambio las fuentes de datos de las liquidaciones municipales son las ya descritas para los ODS 1 y ODS 4: el portal [CONPREL: CONSULTA PRESUPUESTOS Y LIQUIDACIONES DE EELL](https://serviciostelematicosext.hacienda.gob.es/SGFAL/CONPREL){target="_blank"} (hay que marcar el año y si se quieren presupuestos o liquidaciones. El portal facilita un base de datos en *Access* de la que hemos extraído los datos en formato texto para su posterior procesamiento.
Como último apunte destacar que **los porcentajes calculados por el Fons Valencà per la Solidaritat son ligeramente diferentes de los nuestros** por el hecho que **nuestro método de cálculo** del denominador del porcentaje, esto es, los **Ingresos Propios Municipales, es probablemente diferente**. En futuro habrá que considerar la posibilidad de **uniformar criterios con el FVS** en este sentido.

<h3>Panel de índices integrados por ODS</h3>
Cada indicador se ha normalizado para su agregación en una tabla de resultados agrupados. Los indicadores se **normalizan** utilizando el **método de mínimo y máximo**, siguiendo la fórmula:
$X_i=\frac{x_i-x_{min}}{x_{max}-x_{min}}$ para los indicadores que van en la misma dirección del ODS (por ejemplo, Tasa de Recogida de Envases Ligeros), y la fórmula: $X_i=\frac{x_{max}-x_i}{x_{max}-x_{min}}$, para los que van en dirección contraria (por ejemplo, Tasa de Pobreza Severa).

La función del Panel es **facilitar la visualización *sinóptica* de los indicadores en estudio**, pero **no tiene valor científico**. Este tipo de operaciones de integración de indicadores para generar índices compuestos, están muy *de moda* hoy en día, pero **pueden ser imprecisas y sesgadas**, si son incompletas las dimensiones que operativizan el concepto, como sería en nuestro caso (hemos utilizado las dimensiones que hemos podido encontrar, no todas las que serían necesarias).

Por ello, no hemos realizado ponderaciones dentro de cada índice compuesto, ni hemos separado categorías de municipios dentro del panel, ni hemos establecido umbrales para eliminar valores atípicos. Todas estas operaciones serían necesarias en el caso que se quisieran establecer (sobre todos los ODS, o algunos de ellos) unos índices de valor científico (para ello, sería necesario disponer de unos indicadores que cubrieran las todas las principales dimensiones del ODS, que, por lo general, son muchas).

</div>



# Fuentes de datos {data-navmenu="Aspectos metodológicos"}


```{r eval=FALSE, fig.width= 13.3}
knitr::include_url("https://analysis.cat/cruzroja/ods/CatalogoDatos.html", 
                   height = '700px')
```

<div class="metodologia" style= "margin-left:10px; margin-right:20px;padding-bottom: 50px; text-align:justify;">
<h1 style= "color:#8e131d";>Fuentes de datos</h1>
<h3><b>Mapas de municipios y provincias</b></h3>
- [Limites administrativos municipios CVA](https://dadesobertes.gva.es/dataset/7928cfb8-88f7-4055-98e2-a40f9c8316a8/resource/47078a02-1cc4-4a34-ae39-f4978b21c228/download/ca_municipios_20240305.zip)
- [Límites administrativos provincias](https://public.opendatasoft.com/explore/?sort=modified){target="_blank"}

<h3><b>Datos de población</b></h3>
- [IVE - Banco de datos territorial: Padrón general años 1996-2024](https://bdt.gva.es/bdt/res_optimo_static.php?cons=C1V4873&idioma=cas&form=xls){target="_blank"}
- [INE: Padrón 2022 por edades - Año a año - Alicante/Alacant](https://www.ine.es/jaxiT3/Tabla.htm?t=33591&L=0){target="_blank"}
- [INE: Padrón 2022 por edades - Año a año - Castellón/Castelló](https://www.ine.es/jaxiT3/Tabla.htm?t=33757&L=0){target="_blank"}
- [INE: Padrón 2022 por edades - Año a año - Valencia/Valéncia](https://www.ine.es/jaxiT3/Tabla.htm?t=33949&L=0){target="_blank"}
- [INE: Censo de población por edades, año a año, 2023 y 2024](https://www.ine.es/dynt3/inebase/index.htm?padre=10607&capsel=10607){target="_blank"}
- [Códigos municipales y correspondencias comarcales](https://pegv.gva.es/es/comarques){target="_blank"}. Hay que recopilar.


<h3><b>Datos ODS 1</b></h3>
- [Tasa de Riesgo de Pobreza y Tasa de Pobreza Severa: Alicante/Alacant: INE - Atlas de distribución de renta de los hogares](https://www.ine.es/jaxiT3/Tabla.htm?t=30838&L=0){target="_blank"}
- [Tasa de Riesgo de Pobreza y Tasa de Pobreza Severa: Castellón/Castelló - Atlas de distribución de renta de los hogares ](https://www.ine.es/jaxiT3/Tabla.htm?t=30967&L=0){target="_blank"}
- [Tasa de Riesgo de Pobreza y Tasa de Pobreza Severa: Valencia/Valéncia - Atlas de distribución de renta de los hogares](https://www.ine.es/jaxiT3/Tabla.htm?t=31255&L=0){target="_blank"}

1. Para **Población en riesgo de pobreza** seleccionar *Población con ingresos inferiores al 60% de la mediana*.
2. Para **Población en pobreza severa** seleccionar *Población con ingresos inferiores al 40% de la mediana*

- [Tasa de Pobreza Infantil Severa: Alicante/Alacant: INE - Atlas de distribución de renta de los hogares](https://www.ine.es/jaxiT3/Tabla.htm?t=30839&L=0){target="_blank"}
- [Tasa de Pobreza Infantil Severa: Castellón/Castelló - Atlas de distribución de renta de los hogares ](https://www.ine.es/jaxiT3/Tabla.htm?t=30968&L=0){target="_blank"}
- [Tasa de Pobreza Infantil Severa: Valencia/Valéncia - Atlas de distribución de renta de los hogares](https://www.ine.es/jaxiT3/Tabla.htm?t=31255&L=0){target="_blank"}

Seleccionar *Población con ingresos inferiores al 40% de la mediana* y Tramos de edad: *Menos de 18 años*.

- [Tasa de gasto en Servicios sociales y promoción social: CONPREL: CONSULTA PRESUPUESTOS Y LIQUIDACIONES DE EELL](https://serviciostelematicosext.hacienda.gob.es/SGFAL/CONPREL){target="_blank"}
Seleccionar Ejercicio: *2022*, *Liquidaciones*, hacer clic en *Datos por Entidad Local. Máximo nivel de desglose (Formato ACCESS)*

<h3><b>Datos ODS 2</b></h3>
**Tasa de privación material severa**: [Tasa de privación material severa: comarcal - Banco da Datos Terrirorial - IVE](https://bdo.gva.es/bdo/res_optimo_static.php?cons=V0025_C2D0022&idioma=cas&form=xlsx){target="_blank"}. Para los datos de Pobreza Severa, ver ODS 1.

<h3><b>Datos ODS 3</b></h3>
**Tasa de defunciones prematuras**, **Edad media de defunción**, **Tasa de mortalidad por suicidio** y **Tasa de mortalidad por suicidio**: [microdatos de mortalidad y sus causas](https://www.ine.es/dyngs/INEbase/es/operacion.htm?c=Estadistica_C&cid=1254736176780&menu=resultados&idp=1254735573175#_tabs-1254736195294){target="_blank"} facilitados por el **Instituto Nacional de Estadística**. **Remesa directa vía email**.

<h3><b>Datos ODS 4</b></h3>
- [Completamiento segunda etapa de Educación Secundaria y Postsecundaria no Superior - Censo Anual 2021-2022 (INE)](https://www.ine.es/dynt3/inebase/es/index.htm?padre=10608&capsel=10612){target="_blank"}. Hay que realizar dos selecciones: una para los municipios de más de 500 habitantes o más, y una para municipios de menos de 500 habitantes.
- **Tasa de gasto municipal medio en educación**: Ver *Tasa de gasto en Servicios sociales y promoción social* (ODS 1).
- **Actividades de educación para el desarrollo en centros educativos del municipio (2020)**: datos facilitados vía email por la **Dirección General de Cooperación y Solidaridad** de la GVA.

<h3><b>Datos ODS 5</b></h3>
- **Tasa de delitos contra la libertad sexual**: Ir a [Balance trimestral de la criminalidad, 4º trimestre 2024](https://estadisticasdecriminalidad.ses.mir.es/publico/portalestadistico/datos.html?type=pcaxis&path=/DatosBalanceAnt/20244/&file=pcaxis){target="_blank"}: ver opción **1.3**.
- [Participación del municipio a la Red Valenciana de Igualdad](https://inclusio.gva.es/es/web/igualtat-i-institut-de-les-dones/xarxa-valenciana-d-igualtat){target="_blank"}. Para recopilar los miembros de mancomunidades descargar los ficheros desde el [Registro de Entidades Locales](https://ssweb.seap.minhap.es/REL/frontend/inicio/mancomunidades){target="_blank} del Ministerio de Política Territorial y Memoria Historica.

<h3><b>Datos ODS 6</b></h3>
**Vulnerabilidad municipal por contaminación de las aguas por nitratos**: recopilar manualmente los municipios indicados en los tres decretos:

- [Aguas subterráneas: DECRET 86/2018, de 22 de juny](https://mediambient.gva.es/documents/163005665/169939259/Municipios+vulnerables_MASubt.pdf/730c4afb-bddf-413f-8af2-466367f456e0){target="_blank"}. 
- [Aguas supeficiales: DECRET 86/2018, de 22 de juny](https://mediambient.gva.es/documents/163005665/169939259/Municipios+vulnerables_MASuperf.pdf/5934d2d8-862f-43a8-9b0d-2b4355df573c){target="_blank"}. 
- [Ampliación: DECRET 81/2022, de 10 de juny](https://dogv.gva.es/datos/2022/06/21/pdf/2022_5520.pdf){target="_blank"}.

<h3><b>Datos ODS 7</b></h3>
- **Tasa de viviendas con aislamiento deficiente**: descargar datos de 2022 de del [Portal de datos abiertos del registro de los certificados de eficiencia energética en la Comunitat Valenciana](https://gceedadesobertes.aven.es/dadesobertes/){target="_blank}.
- **Nivel estimado de riesgo de vulnerabilidad energética**: recuperar datos de Pobreza severa (ODS1).

<h3><b>Datos ODS 8</b></h3>

- **Tasa de demandantes de empleo sobre la población entre 16 y 64 años (2024)**: ir a [Datos demandantes de empleo por municipios a 31 de diciembre 2024 (1 de enero 2025)](https://labora.gva.es/documents/166000883/177120029/Demandantes+activos+parados+por+municipios+%28XLSX%29.xlsx/5711e6e4-4c3b-48ee-aa39-7f5dee3d804b){target="_blank"}. Para la población por edad y municipios capítulo **Datos de población**.
- **Tasa de demandantes de empleo menores de 25 años (2024)**: ver punto anterior.

<h3><b>Datos ODS 10</b></h3>
- **Tasa de personas con ingresos inferiores al 50% de la mediana (2022)**: ir a [Atlas de distribución de renta de los hogares](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}: [Alicante/Alacant](https://www.ine.es/jaxiT3/Tabla.htm?t=30839&L=0){taget="_blank"}, [Castellón/Castelló](https://www.ine.es/jaxiT3/Tabla.htm?t=30967&L=0){target="_blank"}, [Valencia/Valéncia](https://www.ine.es/jaxiT3/Tabla.htm?t=31255&L=0){target="_blank"}. Elegir *Población con ingresos por unidad de consumo inferiores al 50% de la mediana*.
- **Índice Gini (2022)**: ir a [Atlas de distribución de renta de los hogares](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}: [Alicante/Alacant](https://www.ine.es/jaxiT3/Tabla.htm?t=37733&L=0){target="_blank"}, [Castellón/Castelló](https://www.ine.es/jaxiT3/Tabla.htm?t=37691&L=0){target="_blank"}, [Valencia/Valéncia](https://www.ine.es/jaxiT3/Tabla.htm?t=37721&L=0){target="_blank"}.
- **Tasa de dependencia (2022)**: ver arriba **INE: Padrón 2022 por edades - Año a año**.

<h3><b>Datos ODS 11</b></h3>
- **Vulnerabilidad urbana**: para datos de *Riesgo de Pobreza*, ver *ODS 1*, elegir las mismas opciones excepto *Secciones*, en lugar de municipios. Descargar los datos de [Habitantes por secciones censales (2022)](https://www.ine.es/dynt3/inebase/index.htm?padre=7132){target="_blank"}. Hay que seleccionar la provincia, la opción *Porcentaje de población con ingresos por unidad de consumo por debajo/encima de determinados umbrales relativos por sexo*, el año (máximo 2022), y la opción *Población con ingresos por unidad de consumo inferiores al 60% de la mediana*.
- **Nivel de contaminación por PM10**: [Datos diarios contaminación - 2023](https://www.miteco.gob.es/content/dam/miteco/es/calidad-y-evaluacion-ambiental/sgalsi/atm%c3%b3sfera-y-calidad-del-aire/evaluaci%c3%b3n-2023/Datos%20diarios%202023.zip){target="_blank"}.
- **Índice de despoblación**: [Datos de densidad municipal (2024)](https://bdt.gva.es/bdt/res_optimo_static.php?cons=C0V6449&idioma=cas&form=xlsx){target="_blank"}.

<h3><b>Datos ODS 12</b></h3>
- **Recogida selectiva de envases ligeros**: recopilar datos del buscador de ECOEMBES [Recogida selectiva de envases domesticos](https://www.ecoembes.com/es/el-proceso-de-reciclaje/datos-de-reciclaje-de-envases-domestico-en-espana/recogida-selectiva-de-envases-domesticos/barometro){target="_blank"}.
- **Recogida selectiva de papel y cartón**: ídem.
- **Recogida selectiva de vidrio**: [Datos de **ECOVIDRIO**](https://www.ecovidrio.es/reciclaje/datos-reciclaje){target="_blank"} (hay que seleccionar el año, 2022, la comunidad autónoma y las tres provincias valencianas).
- **Ecoparques en el municipio**: recopilar datos del [Buscador de productores y gestores de residuos](https://residuos.gva.es/RES_BUSCAWEB/buscador_residuos_avanzado.aspx?idioma=C){target="_blank"} (Categoría "Ecoparques").

<h3><b>Datos ODS 13</b></h3>
- **Participación en compromisos internacionales por el clima**: [GCofM: Base de datos de proyectos y firmantes de la UE - 2023](https://jeodpp.jrc.ec.europa.eu/ftp/public/JRC-OpenData/GCOM-MyCovenant/2023_Fourth_release/df1_Signatories_4th%20Release%20-%20March%202023.xlsx){target="_blank"}, procesar la tercera hoja de cálculo.

<h3>ODS 15</h3>
- **Tasa de ocupación de bosques**:
1. [Superficie cadastral rústica total - Alicante/Alacant](https://www.catastro.hacienda.gob.es/jaxi/tabla.do?path=/est2024/catastro/rustico/&file=04103.px&type=pcaxis&L=0){target="_blank"}.
2. [Superficie cadastral rústica total - Castellón/Castelló](https://www.catastro.hacienda.gob.es/jaxi/tabla.do?path=/est2024/catastro/rustico/&file=04112.px&type=pcaxis&L=0){target="_blank"}.
3. [Superficie cadastral rústica total - Valencia/Valéncia](https://www.catastro.hacienda.gob.es/jaxi/tabla.do?path=/est2024/catastro/rustico/&file=04146.px&type=pcaxis&L=0){target="_blank"}.

a. [% Tipos de cultivo - Alicante/Alacant](https://www.catastro.hacienda.gob.es/jaxi/tabla.do?path=/est2024/catastro/rustico/&file=04203.px&type=pcaxis&L=0){target="_blank"}.
b. [% Tipos de cultivo - Castellón/Castelló](https://www.catastro.hacienda.gob.es/jaxi/tabla.do?path=/est2024/catastro/rustico/&file=04212.px&type=pcaxis&L=0){target="_blank"}.
c. [% Tipos de cultivo - Valencia/Valéncia](https://www.catastro.hacienda.gob.es/jaxi/tabla.do?path=/est2024/catastro/rustico/&file=04246.px&type=pcaxis&L=0){target="_blank"}.

- [Superficies totales de los municipios (2024)](https://bdt.gva.es/bdt/res_optimo_static.php?cons=C0V6527&idioma=val&form=xlsx){target="_blank"}.

<h3>ODS 16</h3>
- **Tasa de criminalidad general**: [Balance trimestral de la criminalidad, 4º trimestre 2024](https://estadisticasdecriminalidad.ses.mir.es/publico/portalestadistico/datos.html?type=pcaxis&path=/DatosBalanceAnt/20244/&file=pcaxis){target="_blank"}. Seleccionar **1.3**.
- **Tasa de de homicidios e intentos de homicidios**: ídem.

<h3>ODS 17</h3>
- **Miembros de la Red de Ciudades Educadoras**: [página web de la aAsociación Internacional de Ciudades Educadoras (AICE)](https://www.edcities.org/listado-de-las-ciudades-asociadas/){target="_blank"}. Marcar *España*.
- **Tasa de presupuesto dedicado a Cooperacion Internacional**: datos de importes aportados a Cooperación Internacional (2021), facilitados directamente por el FVS, completados por [datos recopilados de la FEMP](http://cooperacion.femp.es/){target="_blank"} y los [datos de las liquidaciones de presupuestos municipales de 2021](https://serviciostelematicosext.hacienda.gob.es/SGFAL/CONPREL){target="_blank"}. Marcar el año y si se quieren presupuestos o liquidaciones.
</div>


# Bibliografia {data-navmenu="Aspectos metodológicos"}


```{r eval=FALSE, fig.width= 13.3}
knitr::include_url("https://analysis.cat/cruzroja/ods/bibliografia.html", 
                   height = '700px')
```
<div class="metodologia" style= "margin-left:10px; margin-right:20px;padding-bottom: 50px; text-align:justify;">
<h1 style= "color:#8e131d";>Bibliografía</h1>
<h3><b>Bibliografía general</b></h3>
- La página web [Indicadores de la Agenda 2030 para el Desarrollo Sostenible](https://www.ine.es/dyngs/ODS/es/index.htm){target="_blank"} del Instituto Nacional de Estadística.
- [Sisto, R., Benayas, J., 2021. *Los municipios de la Comunidad de Madrid y la Agenda 2030. Diagnóstico sobre su grado de aplicación*. INAECU y REDS / SDSN-SPAIN](https://reds-sdsn.es/ods-madrid/){target="_blank"} de la Red Española de Desarrollo Sostenible (REDS).
- [REDS, 2020. *Los ODS en 100 ciudades españolas (2ª edición)*](https://reds-sdsn.es/informe-ods-ciudades-2020/){target="_blank"}.

<h3><b>Bibliografía específica</b></h3>

<h3>ODS 1</h3>
[III Informe 2022. *El mapa de la pobreza severa en España*. Abandonadas, EAPN España, 2022](https://www.eapn.es/ARCHIVO/documentos/noticias/1671549839_2022-abandonadas.-la-pobreza-severa-en-espaa.pdf){target="_blank"}.

<h3>ODS 7</h3>
- [*Informe de Indicadores de Pobreza Energética en España*, Escuela Técnica Superior de Ingeniería (ICAI) Universidad Pontificia Comillas, 2022](https://www.comillas.edu/noticias/la-pobreza-energetica-siguio-creciendo-en-espana-en-2022/#:~:text=El%20Informe%20de%20Indicadores%20de,temperatura%20adecuada%20en%20sus%20hogares.){target="_blank"}.
- [Sujar Cost A., Analisis geoespacial de la distribución de la pobreza energética del sector residencial de la comunidad valenciana, 2022](https://riunet.upv.es/handle/10251/185142?show=full){target="_blank"}.
- [L.Desvallées, *Identificación, localización i caracterización de la vulnerabilidad energética a nivel de sección censal en el municipio de Barcelona*, Scripta Nova, 2021](https://revistes.ub.edu/index.php/ScriptaNova/article/view/30257){target="_blank"}.
- AAVV, *Pobreza energética en la Comunitat Valenciana*, Institut valencià de l'Edificació, 2022.

<h3>ODS 11</h3>
- [*WHO global air quality guidelines*, World Health Organization, 2021](https://www.who.int/publications/i/item/9789240034228){target="_blank"}.
- [Diagnóstico estrategia nacional frente al reto demográfico. Eje despoblación, 2020](https://www.miteco.gob.es/content/dam/miteco/es/reto-demografico/temas/analisis-cartografia/diagnostico_eje_despoblacion_tcm30-517769.pdf){target="_blank"}.


<h3>ODS 17</h3>
[Joaquim Solé Vilanova, Criteris d’aplicació del 0’7% dels ingressos propis municipals a la cooperació al desenvolupament. Justificació tècnica, Fons Català de Cooperació al Desenvolupament, 2016 ](https://www.fonscatala.org/ca/comunicacio/recursos/justificacio-tecnica-de-laplicacio-del-07-en-cooperacio){target="_blank"}.
</div>


